# SAML CTF Exploit Guide

## Challenge Overview
- **Target**: https://saml-web.challs.infobahnc.tf
- **Goal**: Get flag by appearing as user `akadmin`
- **Current Access**: Regular user `sahas`

## Vulnerability Analysis

### Code Review (index.js)
The application extracts username from SAML assertion:
```javascript
const username = xmlDoc.querySelector(
    'Attribute[Name="http://schemas.goauthentik.io/2021/02/saml/username"] AttributeValue'
)?.textContent;
if ( username === 'akadmin' ) {
    res.type( 'text/plain' ).send( process.env.FLAG || 'flag{fake}' );
}
```

**Key Points**:
- Signature verification is robust (xml-crypto library)
- Username comes from SAML attribute with specific name
- Must match exactly `akadmin` (case-sensitive)
- Authentik IdP allows self-registration

---

## Attack Vectors (Ordered by Feasibility)

### ✅ Vector 1: Username Case Manipulation
**Theory**: Try creating account with variations like `Akadmin`, `AKADMIN`, `akAdmin`
- If Authentik normalizes on display but preserves case in SAML attribute
- Code does strict equality check, so needs exact match
- **Probability**: Low (Authentik likely prevents admin-like names)

### ✅ Vector 2: Property Mapping Manipulation  
**Theory**: Regular users can create/modify SAML property mappings
- Create mapping that returns static value `akadmin`
- Apply to existing provider or create duplicate
- **Steps**:
  1. Login as `sahas`
  2. Navigate to Admin Interface (if accessible)
  3. Go to Customization → Property Mappings
  4. Create new SAML mapping with expression: `return "akadmin"`
  5. Apply to `flaggetter` provider

**Probability**: Medium-High (common misconfiguration in CTFs)

### ✅ Vector 3: XML Comments Injection
**Theory**: Inject XML comment to bypass username restriction
- Create user like `ak<!-- x -->admin`
- If Authentik stores verbatim but SAML attribute strips comments
- **Probability**: Very Low (Authentik validates usernames)

### ✅ Vector 4: Unicode/Homoglyph Attack
**Theory**: Use lookalike characters
- Try Unicode variations: `аkadmin` (Cyrillic 'а'), `akаdmin`
- **Probability**: Very Low (strict validation)

### ✅ Vector 5: SAML Response Manipulation (Advanced)
**Theory**: Modify SAML response in transit
- Intercept SAMLResponse parameter
- Decode → Decompress → Modify username → Re-sign
- **Blocker**: Need private key (not available on remote)

### ✅ Vector 6: Race Condition on Username
**Theory**: Delete/rename existing akadmin, claim username
- Requires finding/exploiting admin account first
- **Probability**: Low (circular dependency)

### ✅ Vector 7: Attribute Name Confusion
**Theory**: Create attribute with slight variation
- Try different namespace/name that still matches CSS selector
- CSS selector uses `Attribute[Name="..."]` - exact match required
- **Probability**: Very Low

### ✅ Vector 8: Provider Configuration Export/Import
**Theory**: Export provider config, modify, reimport
- If export includes sensitive mappings with predictable tokens
- **Probability**: Low without additional info leak

---

## Recommended Attack Sequence

### Phase 1: Reconnaissance (5-10 min)
1. **Enumerate available Authentik endpoints**:
   ```
   /if/admin/          # Admin interface
   /api/v3/            # API root
   /api/v3/core/users/ # User management
   /api/v3/propertymappings/saml/ # Property mappings
   /api/v3/providers/saml/ # SAML providers
   ```

2. **Check API access** (may need session cookies):
   ```bash
   curl -b cookies.txt https://saml-web.challs.infobahnc.tf/api/v3/propertymappings/saml/
   ```

3. **Inspect current user permissions**:
   - Login as `sahas`
   - Check if Admin link visible in UI
   - Try accessing `/if/admin/`

### Phase 2: Property Mapping Attack (Primary)
If you can access property mappings:

1. **List existing mappings**:
   ```bash
   GET /api/v3/propertymappings/saml/
   ```

2. **Create malicious mapping**:
   ```json
   POST /api/v3/propertymappings/saml/
   {
     "name": "evil-username-override",
     "saml_name": "http://schemas.goauthentik.io/2021/02/saml/username",
     "expression": "return 'akadmin'"
   }
   ```

3. **Get flaggetter provider ID**:
   ```bash
   GET /api/v3/providers/saml/?search=flaggetter
   ```

4. **Update provider mappings**:
   ```json
   PATCH /api/v3/providers/saml/{provider_id}/
   {
     "property_mappings": ["<your-evil-mapping-id>"]
   }
   ```

5. **Trigger new SAML flow**:
   - Visit: https://saml-web.challs.infobahnc.tf/flag
   - Should redirect to IdP, authenticate, return with `akadmin` username

### Phase 3: Alternative Username Registration
Try creating accounts with:
- `akadmin` (direct - likely blocked)
- `ak admin` (space)
- `akadmin ` (trailing space)
- `akadmin\u200B` (zero-width space)
- `akadmin\n` (newline)

### Phase 4: SAML Response Interception & Analysis
Use the provided decoder tool to inspect actual SAML structure:

```bash
# Run the decoder on a captured SAMLResponse
node saml_decoder.js <base64_saml_response>
```

Look for:
- Signature algorithm used
- Transform types
- Attribute structure
- Any unsigned sections

---

## Tools Provided

### 1. SAML Response Decoder (`saml_decoder.js`)
Decodes and pretty-prints SAML responses from URL parameters

### 2. API Helper (`authentik_api.js`)
Automates property mapping creation and provider modification

### 3. Burp Suite / ZAP Configuration
Import the provided session handling rules for SAML manipulation

---

## Expected Solution

Based on typical CTF patterns, the intended solution is likely:

**Misconfigured RBAC allowing regular users to create property mappings**

1. Login as any user (sahas/123)
2. Access property mapping creation (no admin check)
3. Create static mapping returning `akadmin`
4. Provider automatically uses all available mappings OR regular users can modify provider
5. Next SAML authentication includes malicious attribute
6. Flag retrieved

---

## Debug Commands

### Decode SAMLResponse from URL
```bash
# Extract from browser Network tab, decode:
echo "H4sIAAAAAAAA..." | base64 -d | zlib-flate -uncompress
```

### Check Authentik Version
```bash
curl https://saml-web.challs.infobahnc.tf/api/v3/root/config/
```

### Export SAML Metadata
```bash
wget https://saml-web.challs.infobahnc.tf/application/saml/flaggetter/metadata/
```

---

## Indicators of Success

- [ ] Can access `/if/admin/` or `/api/v3/propertymappings/`
- [ ] Can create new property mapping
- [ ] Can list/modify SAML providers
- [ ] SAMLResponse contains `akadmin` in username attribute
- [ ] Flag appears after SAML authentication

---

## Next Steps

Run the provided tools and report back:
1. What you see when accessing `/if/admin/`
2. API response from `/api/v3/propertymappings/saml/`
3. Any SAML response you can capture

I'll provide targeted exploit code based on your findings.
